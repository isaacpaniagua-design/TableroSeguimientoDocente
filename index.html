<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduControl Pro - Acceso Institucional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="api.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9f0",
                100: "#dcf2dc",
                500: "#2E7D32",
                600: "#1B5E20",
                700: "#155315",
              },
            },
          },
        },
      };

      // Inicialización segura de Firebase (espera a que el SDK cargue)
      (function initFirebase(){
        try {
          var cfg = {
            apiKey: "AIzaSyCtLZgfTqu3lJAtpH-EtY84icBcyeLSVyE",
            authDomain: "tableroseguimientodocente.firebaseapp.com",
            projectId: "tableroseguimientodocente",
            storageBucket: "tableroseguimientodocente.appspot.com",
            messagingSenderId: "270226560509",
            appId: "1:270226560509:web:f80aac186a6db942dfb594"
          };
          function doInit(){
            try {
              if (window.firebase && (!firebase.apps || !firebase.apps.length)) {
                firebase.initializeApp(cfg);
                window.__fb = { db: firebase.firestore(), auth: firebase.auth() };
              } else if (window.firebase && firebase.apps && firebase.apps.length) {
                // Ya inicializado previamente
                window.__fb = { db: firebase.firestore(), auth: firebase.auth() };
              }
            } catch (e) {
              console.warn("Firebase init error", e);
            }
          }
          if (document.readyState === "complete") {
            doInit();
          } else {
            window.addEventListener("load", doInit);
          }
        } catch(e) { console.warn("Firebase init wrapper error", e); }
      })();

      function initiateGoogleSignIn(){ try { if (!window.__fb || !__fb.auth) throw new Error("Firebase no inicializado"); var provider = new firebase.auth.GoogleAuthProvider(); __fb.auth.signInWithPopup(provider).then(function(){ try { document.getElementById("loginPage") && document.getElementById("loginPage").classList.add("hidden"); document.getElementById("mainDashboard") && document.getElementById("mainDashboard").classList.remove("hidden"); if (typeof initializeApp === "function") initializeApp(); } catch(e) {} }).catch(function(err){ console.error(err); alert("No se pudo iniciar sesi�n: "+ (err && err.message)); }); } catch(e) { console.error(e); } }
      // Ensure functions are available for inline onclick/data-callback
      if (typeof window !== 'undefined') {
        try {
          window.initiateGoogleSignIn = initiateGoogleSignIn;
          } catch (e) {
          console && console.warn && console.warn('Function export error:', e);
        }
      }
    </script>



    <!-- Firebase SDK (Compat) -->

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
      .mobile-menu-open {
        transform: translateX(0);
      }

      .mobile-menu-closed {
        transform: translateX(-100%);
      }

      .mobile-menu {
        transition: transform 0.3s ease-in-out;
      }

      .backdrop {
        backdrop-filter: blur(8px);
        background: rgba(0, 0, 0, 0.5);
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      .animate-fade-in {
        animation: fadeIn 0.6s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .progress-bar {
        transition: width 0.5s ease;
      }

      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #2e7d32;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      /* Mini spinner para refrescos ligeros (no intrusivo) */
      .mini-spinner {
        border: 2px solid #e5e7eb; /* gray-200 */
        border-top: 2px solid #2e7d32; /* primary */
        border-radius: 50%;
        width: 12px;
        height: 12px;
        animation: spin 0.9s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .chart-type-btn {
        transition: all 0.3s ease;
      }

      .chart-type-btn.active {
        background-color: #2e7d32 !important;
        color: white !important;
      }

      .chart-type-btn:not(.active):hover {
        background-color: #e5e7eb;
      }
      /* Oculta bloque de acceso demo no utilizado */
      #demoAccessBlock { display: none !important; }

      .login-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .login-card {
        backdrop-filter: blur(16px);
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .floating-shapes {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 1;
      }

      .shape {
        position: absolute;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
      }

      .shape:nth-child(1) {
        width: 80px;
        height: 80px;
        top: 20%;
        left: 10%;
        animation-delay: 0s;
      }

      .shape:nth-child(2) {
        width: 120px;
        height: 120px;
        top: 60%;
        right: 10%;
        animation-delay: 2s;
      }

      .shape:nth-child(3) {
        width: 60px;
        height: 60px;
        bottom: 20%;
        left: 20%;
        animation-delay: 4s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        50% {
          transform: translateY(-20px) rotate(180deg);
        }
      }

      .google-btn {
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.25);
      }

      .google-btn:hover {
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.35);
        transform: translateY(-1px);
      }

      .pulse-animation {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen">
    <!-- Global Loading Modal -->
    <div
      id="globalLoadingModal"
      class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-40"
      style="z-index: 9999;"
    >
      <div class="bg-white rounded-xl shadow-2xl p-6 flex items-center space-x-4">
        <div class="loading-spinner"></div>
        <div>
          <div id="globalLoadingText" class="text-gray-900 font-medium">
            Procesando...
          </div>
          <div class="text-gray-500 text-sm">Por favor espera un momento.</div>
        </div>
      </div>
    </div>

    <script>
      // Simple global loading helpers
      function showLoading(message) {
        try {
          const modal = document.getElementById("globalLoadingModal");
          const text = document.getElementById("globalLoadingText");
          if (text && typeof message === "string" && message.trim()) {
            text.textContent = message;
          }
          if (modal) {
            modal.classList.remove("hidden");
            modal.classList.add("flex");
          }
        } catch (e) { /* no-op */ }
      }
      function hideLoading() {
        try {
          const modal = document.getElementById("globalLoadingModal");
          if (modal) {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          }
        } catch (e) { /* no-op */ }
      }
    </script>

    <!-- Activity Detail Modal -->
    <div id="activityDetailModal" class="fixed inset-0 hidden items-center justify-center z-50 p-4 bg-black bg-opacity-50">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Detalle de actividad</h3>
          <button onclick="closeActivityDetail()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-2 text-sm text-gray-700">
          <div><span class="font-medium">Docente:</span> <span id="actDetTeacher"></span></div>
          <div><span class="font-medium">Actividad:</span> <span id="actDetName"></span></div>
          <div><span class="font-medium">Estado:</span> <span id="actDetStatus"></span></div>
          <div><span class="font-medium">Actualizado por:</span> <span id="actDetBy"></span></div>
          <div><span class="font-medium">Fecha:</span> <span id="actDetAt"></span></div>
        </div>
        <div class="mt-4 text-right">
          <button onclick="closeActivityDetail()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-700">Cerrar</button>
        </div>
      </div>
    </div>

    <script>
      function openActivityDetail(teacherId, activity){
        try {
          var list = (typeof filteredTeachers !== 'undefined' && filteredTeachers && filteredTeachers.length) ? filteredTeachers : teachers;
          var t = (list||[]).find(function(x){ return String(x.id) === String(teacherId); });
          var el = function(id){ return document.getElementById(id); };
          if (!t) { alert('No se encontró el docente'); return; }
          var status = (typeof getActivityState === 'function') ? (getActivityState(t, activity) ? 'Completada' : 'No completada') : ((t.activities && t.activities[activity]) ? 'Completada' : 'No completada');
          var meta = (t.activitiesMeta && t.activitiesMeta[activity]) ? t.activitiesMeta[activity] : {};
          var by = meta && meta.updatedBy ? meta.updatedBy : '-';
          var at = meta && meta.updatedAt ? formatTs(meta.updatedAt) : '-';
          el('actDetTeacher').textContent = (t.name||'') + ' ' + (t.lastName||'') + ' (' + (t.id||'') + ')';
          el('actDetName').textContent = activity;
          el('actDetStatus').textContent = status;
          el('actDetBy').textContent = by;
          el('actDetAt').textContent = at;
          var m = document.getElementById('activityDetailModal');
          m.classList.remove('hidden'); m.classList.add('flex');
        } catch (e) { console.warn(e); }
      }
      function closeActivityDetail(){ try { var m=document.getElementById('activityDetailModal'); m.classList.add('hidden'); m.classList.remove('flex'); } catch(e){} }
      function formatTs(ts){
        try {
          // Firestore Timestamp has toDate(); fallback to Date
          var d = (ts && typeof ts.toDate==='function') ? ts.toDate() : (ts instanceof Date ? ts : null);
          if (!d) return '-';
          var pad = function(n){ return (n<10?'0':'')+n; };
          return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes());
        } catch(e){ return '-'; }
      }
    </script>

    <!-- Admin Access FAB + Panel -->
    <div id="adminFab" class="fixed bottom-4 left-4 hidden z-40">
      <button id="adminFabBtn" class="px-4 py-2 rounded-full bg-primary-600 text-white shadow-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
        <i class="fa-solid fa-user-shield mr-2"></i> Entrar como admin
      </button>
    </div>

    <div id="adminPanel" class="fixed inset-0 hidden z-50">
      <div class="absolute inset-0 bg-black bg-opacity-50"></div>
      <div class="relative mx-auto mt-20 w-11/12 max-w-2xl bg-white rounded-xl shadow-2xl">
        <div class="flex items-center justify-between p-4 border-b">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-user-shield text-primary-600"></i>
            <h3 class="text-lg font-semibold text-gray-800">Panel de administración</h3>
          </div>
          <button id="adminCloseBtn" class="text-gray-400 hover:text-gray-600" aria-label="Cerrar">✕</button>
        </div>
        <div class="p-4 space-y-4">
          <p class="text-sm text-gray-600">Acceso concedido a administradores. Las operaciones de escritura están protegidas por reglas de Firestore.</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <button id="adminActionRefresh" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 text-gray-800 text-sm">
              <i class="fa-solid fa-rotate mr-1"></i> Refrescar datos
            </button>
            <button id="adminActionExport" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 text-gray-800 text-sm">
              <i class="fa-solid fa-file-export mr-1"></i> Exportar (placeholder)
            </button>
            <button id="adminActionRecheck" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 text-gray-800 text-sm">
              <i class="fa-solid fa-stethoscope mr-1"></i> Reprobar Health Check
            </button>
            <button id="adminActionSeedDirectory" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 text-gray-800 text-sm">
              <i class="fa-solid fa-address-book mr-1"></i> Cargar directorio docentes
            </button>
            <button id="adminActionSeed" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 text-gray-800 text-sm">
              <i class="fa-solid fa-seedling mr-1"></i> Cargar datos de prueba
            </button>
            <button id="adminActionSignOut" class="px-3 py-2 bg-red-50 rounded hover:bg-red-100 text-red-700 text-sm">
              <i class="fa-solid fa-right-from-bracket mr-1"></i> Cerrar sesión
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(){
        var ADMIN_EMAILS = [
          "isaac.paniagua@potros.itson.edu.mx",
          "saul.grijalva62125@potros.itson.edu.mx",
          "ricardo.carrasco20122@potros.itson.edu.mx"
        ];
        function isAdminUser(user){
          try { return !!(user && user.email && ADMIN_EMAILS.indexOf(user.email) !== -1); } catch(e){ return false; }
        }
        // Expose admin check globally for other modules
        try { window.isAdminUser = isAdminUser; } catch(e) {}
        function qs(id){ return document.getElementById(id); }
        function toggle(el, show){ if (!el) return; if (show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        function updateAdminUI(user){
          var showAdmin = isAdminUser(user);
          toggle(qs('adminFab'), showAdmin);
          if (!showAdmin) toggle(qs('adminPanel'), false);
        }
        function bind(){
          var fabBtn = qs('adminFabBtn');
          var panel = qs('adminPanel');
          var closeBtn = qs('adminCloseBtn');
          if (fabBtn) fabBtn.addEventListener('click', function(){ toggle(panel, true); });
          if (closeBtn) closeBtn.addEventListener('click', function(){ toggle(panel, false); });
          if (panel) panel.addEventListener('click', function(e){ if (e.target === panel) toggle(panel, false); });

          var aRecheck = qs('adminActionRecheck');
          if (aRecheck) aRecheck.addEventListener('click', function(){ try { if (window.runHealthCheck) runHealthCheck(); } catch(e) {} });
          var aRefresh = qs('adminActionRefresh');
          if (aRefresh) aRefresh.addEventListener('click', function(){ try { if (typeof initializeApp === 'function') initializeApp(); } catch(e) {} });
          var aExport = qs('adminActionExport');
          if (aExport) aExport.addEventListener('click', function(){ try { if (window.exportTeachersReport) exportTeachersReport(); else alert('Export no disponible'); } catch(e) { alert('Error al exportar'); } });
          var aSeed = qs('adminActionSeed');
          if (aSeed) aSeed.addEventListener('click', async function(){
            try {
              if (!window.api || typeof api.seedDemoData !== 'function') { alert('Seed no disponible'); return; }
              if (!confirm('Esto creará/actualizará datos de prueba (5 docentes y actividades). ¿Continuar?')) return;
              if (typeof showLoading === 'function') showLoading('Cargando datos de prueba...');
              var r = await api.seedDemoData();
              if (typeof initializeApp === 'function') initializeApp();
              if (typeof showNotification === 'function') showNotification('Datos de prueba cargados ('+(r && r.seeded || 0)+')', 'success');
            } catch (e) {
              console.error(e);
              alert('Error al cargar datos de prueba');
            } finally { if (typeof hideLoading === 'function') hideLoading(); }
          });
          var aSeedDir = qs('adminActionSeedDirectory');
          if (aSeedDir) aSeedDir.addEventListener('click', async function(){
            try {
              if (!window.api || typeof api.seedDirectory !== 'function') { alert('Seed de directorio no disponible'); return; }
              if (!confirm('Esto cargará/actualizará el directorio (correo y número de control) en Firestore. ¿Continuar?')) return;
              if (typeof showLoading === 'function') showLoading('Cargando directorio...');
              var r = await api.seedDirectory();
              if (typeof initializeApp === 'function') await initializeApp();
              if (typeof showNotification === 'function') showNotification('Directorio cargado ('+(r && r.seeded || 0)+')', 'success');
            } catch (e) {
              console.error(e);
              alert('Error al cargar directorio');
            } finally { if (typeof hideLoading === 'function') hideLoading(); }
          });
          var aSignOut = qs('adminActionSignOut');
          if (aSignOut) aSignOut.addEventListener('click', function(){ try { if (typeof logout === 'function') logout(); else if (window.firebase && firebase.auth) firebase.auth().signOut(); } catch(e) {} });
        }
        function init(){ bind(); try { if (window.firebase && firebase.auth) { firebase.auth().onAuthStateChanged(updateAdminUI); updateAdminUI(firebase.auth().currentUser); } } catch(e) {}}
        if (document.readyState === 'complete') init(); else window.addEventListener('load', init);
      })();
    </script>

    <script>
      // Export helpers (XLSX with CSV fallback)
      (function(){
        function formatDate(dt){
          function z(n){ return (n<10?'0':'')+n; }
          return dt.getFullYear()+''+z(dt.getMonth()+1)+''+z(dt.getDate())+'_'+z(dt.getHours())+z(dt.getMinutes());
        }
        function toCSV(headers, rows){
          function esc(v){
            var s = String(v==null?'':v);
            if (s.search(/[",\n]/)>=0) s = '"'+s.replace(/"/g,'""')+'"';
            return s;
          }
          var lines = [ headers.map(esc).join(',') ];
          rows.forEach(function(r){ lines.push(headers.map(function(h){ return esc(r[h]); }).join(',')); });
          return lines.join('\n');
        }
        async function exportTeachersReport(){
          try {
            if (!window.api || typeof api.getPagedData !== 'function') { alert('API no disponible'); return; }
            if (typeof showLoading === 'function') showLoading('Exportando reporte...');
            var isAdmin = false; try { isAdmin = (typeof window.isAdminUser==='function') && window.isAdminUser((firebase && firebase.auth && firebase.auth().currentUser)||null); } catch(_){}
            var resp = await api.getPagedData(1, 1000);
            if (!resp || resp.success === false) { alert('No se pudieron obtener datos'); return; }
            var headersAll = Array.isArray(resp.headers)?resp.headers.slice():[];
            if (headersAll.length && headersAll[0].toLowerCase().startsWith('sel')) headersAll.shift();
            var activities = headersAll.slice(4);
            var rows = Array.isArray(resp.teachers)?resp.teachers:[];

            // Subject filter map
            var subjectMap = {};
            try { if (typeof api.listAllSubjects === 'function') { var s = await api.listAllSubjects(); (s && s.items || []).forEach(function(it){ subjectMap[String(it.id||'')] = Array.isArray(it.subjects)?it.subjects:[]; }); } } catch(_){ }
            var subjectQuery = (window.prompt('Filtrar por materia (deja vacío para todas):','')||'').trim();
            var compQuery = (window.prompt('Filtrar por completitud (todos/completos/parciales/ninguno):','todos')||'').trim().toLowerCase();
            function passCompletion(t){
              if (!activities.length) return compQuery==='todos' || compQuery==='';
              var completed = activities.filter(function(h){ return !!t[h]; }).length;
              if (compQuery==='completos') return completed===activities.length;
              if (compQuery==='ninguno') return completed===0;
              if (compQuery==='parciales') return completed>0 && completed<activities.length;
              return true;
            }
            function passSubject(t){
              if (!subjectQuery) return true;
              var subs = subjectMap[String(t.id||'')] || [];
              return subs.some(function(x){ return String(x||'').toLowerCase()===subjectQuery.toLowerCase(); });
            }
            var filtered = rows.filter(function(t){ return passCompletion(t) && passSubject(t); });

            var headers = ['ID','Nombre','Apellidos'];
            if (isAdmin) { headers.push('Correo','No. Control'); }
            headers = headers.concat(activities);
            var data = filtered.map(function(r){
              var o = { 'ID': r.id||'', 'Nombre': r.name||'', 'Apellidos': r.lastName||'' };
              if (isAdmin) { o['Correo'] = r.email||''; o['No. Control'] = r.controlNumber||''; }
              activities.forEach(function(h){ var v = r[h]; if (typeof v==='boolean') v = v ? 'Sí' : 'No'; o[h] = v==null?'':v; });
              return o;
            });
            var filename = 'reporte_docentes_'+formatDate(new Date());
            if (window.XLSX && XLSX.utils && XLSX.writeFile) {
              var ws = XLSX.utils.json_to_sheet(data, { header: headers });
              var wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, 'Docentes');
              XLSX.writeFile(wb, filename + '.xlsx');
            } else {
              var csv = toCSV(headers, data);
              var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
              var a = document.createElement('a');
              var url = URL.createObjectURL(blob);
              a.href = url; a.download = filename + '.csv'; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(url); document.body.removeChild(a); }, 0);
            }
          } catch(e) {
            console.error('Export error', e);
            alert('Error durante la exportación');
          } finally {
            if (typeof hideLoading === 'function') hideLoading();
          }
        }
        window.exportTeachersReport = exportTeachersReport;
      })();
    </script>

    <script>
      // Ocultar accesos a gestión de actividades desde el dashboard
      (function(){
        function hideActivitiesUI(){
          try {
            document.querySelectorAll('[onclick*="openActivitiesModal"]').forEach(function(el){ el.style.display = 'none'; });
          } catch(e) {}
        }
        if (document.readyState === 'complete') hideActivitiesUI(); else window.addEventListener('load', hideActivitiesUI);
      })();
    </script>

    <script>
      // Enforce admin-only controls inside modals (e.g., Guardar Cambios de Actividades)
      (function(){
        function enforceAdminOnly(){
          try {
            var user = (window.firebase && firebase.auth) ? firebase.auth().currentUser : null;
            var isAdmin = (typeof window.isAdminUser === 'function') ? window.isAdminUser(user) : false;
            var saveBtn = document.querySelector('#activitiesModal button[onclick="saveActivities()"]');
            if (saveBtn) saveBtn.style.display = isAdmin ? '' : 'none';
          } catch (e) {}
        }
        if (document.readyState === 'complete') enforceAdminOnly(); else window.addEventListener('load', enforceAdminOnly);
        try { if (window.firebase && firebase.auth) firebase.auth().onAuthStateChanged(enforceAdminOnly); } catch(e) {}
      })();
    </script>

    <script>
      // Auto refresh UI on data changes from API
      (function(){
        // Indicador ligero y con limitación de frecuencia
        (function(){
          var lastShown = 0;
          var timer = null;
          var MIN_DURATION = 600;   // ms mínimo visible para evitar parpadeo
          var THROTTLE_MS = 3000;   // no mostrar más de una vez cada 3s
          function el(){ return document.getElementById('miniRefreshSpinner'); }
          window.showMiniRefresh = function(){
            var now = Date.now();
            if (now - lastShown < THROTTLE_MS) return; // limitar frecuencia
            lastShown = now;
            var e = el(); if (!e) return;
            e.style.display = '';
            clearTimeout(timer);
            timer = setTimeout(function(){ try { window.hideMiniRefresh(); } catch(_){} }, MIN_DURATION);
          };
          window.hideMiniRefresh = function(){ var e = el(); if (e) e.style.display = 'none'; };
        })();

        function isPromise(p){ return p && typeof p.then === 'function'; }
        async function onChange(){
          try {
            if (typeof showMiniRefresh === 'function') showMiniRefresh();
            if (typeof initializeApp === 'function') {
              var r = initializeApp();
              if (isPromise(r)) await r;
            }
          } catch (err) {
            console && console.warn && console.warn('Refresh after change failed', err);
          } finally {
            try { if (typeof hideMiniRefresh === 'function') hideMiniRefresh(); } catch(_){}
          }
        }
        if (typeof window !== 'undefined') {
          try { window.addEventListener('data:changed', onChange); } catch (e) {}
        }
      })();
    </script>

    <script>
      // Stubs de compatibilidad: neutralizan helpers de GIS si quedaron definidos
      (function(){
        try { window.parseJwt = function(){ return null; }; } catch(e) {}
        try { window.initializeGoogleSignIn = function(){}; } catch(e) {}
        try { window.handleCredentialResponse = function(){}; } catch(e) {}
        try { window.validateInstitutionalEmail = function(){ return true; }; } catch(e) {}
        try { window.initiateGoogleSignIn = function(){ try { if (window.robustGoogleSignIn) robustGoogleSignIn(); } catch(e) {} }; } catch(e) {}
        try { window.checkExistingSession = function(){}; } catch(e) {}
      })();
    </script>

    <!-- FAB de inicio de sesión con Google (redirige) -->
    <div id="loginFab" class="fixed bottom-24 right-4 hidden z-40">
      <button id="loginRedirectBtn" class="px-4 py-2 rounded-full bg-blue-600 text-white shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
        <i class="fa-brands fa-google mr-2"></i> Iniciar sesión con Google
      </button>
    </div>

    <script>
      (function(){
        function qs(id){ return document.getElementById(id); }
        function toggle(el, show){ if (!el) return; if (show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        function storeOAuthIdTokenFromCredential(cred){
          try {
            if (cred && cred.idToken) {
              if (typeof setAuthToken === 'function') setAuthToken(cred.idToken);
              else if (window.api && typeof window.api.setAuthToken === 'function') window.api.setAuthToken(cred.idToken);
              window.__lastAuthTokenType = 'google_oauth';
              return true;
            }
          } catch(e) {}
          return false;
        }
        async function redirectGoogleSignIn(){
          try {
            if (!window.firebase || !firebase.auth) throw new Error('Firebase Auth no disponible');
            var provider = new firebase.auth.GoogleAuthProvider();
            // Forzar redirección (evita bloqueos de popup/FedCM en incógnito)
            await firebase.auth().signInWithRedirect(provider);
          } catch (e) {
            console.error('Error al iniciar sesión (redirect):', e);
            alert('No se pudo iniciar sesión. Revisa que el dominio esté autorizado y habilita pop-ups/cookies para accounts.google.com');
          }
        }
        async function robustGoogleSignIn(){
          try {
            if (!window.firebase || !firebase.auth) throw new Error('Firebase Auth no disponible');
            var provider = new firebase.auth.GoogleAuthProvider();
            try {
              var res = await firebase.auth().signInWithPopup(provider);
              try { var cred = firebase.auth.GoogleAuthProvider.credentialFromResult(res); storeOAuthIdTokenFromCredential(cred); } catch(_) {}
            } catch (err) {
              if (
                (err && err.code && (err.code === 'auth/popup-blocked' || err.code === 'auth/cancelled-popup-request' || err.code === 'auth/popup-closed-by-user')) ||
                (err && err.message && (String(err.message).includes('FedCM') || String(err.message).includes('accounts list is empty') || String(err.message).includes('NetworkError')))
              ) {
                // Fallback a redirect
                await firebase.auth().signInWithRedirect(provider);
              } else {
                throw err;
              }
            }
          } catch (e) {
            console.error('Error al iniciar sesión (robusto):', e);
            alert('No se pudo iniciar sesión. Prueba con el botón de redirección o habilita pop-ups/cookies.');
          }
        }
        function bind(){
          var btn = qs('loginRedirectBtn');
          if (btn) btn.addEventListener('click', redirectGoogleSignIn);
          // Exporta helpers por consola
          window.redirectGoogleSignIn = redirectGoogleSignIn;
          window.robustGoogleSignIn = robustGoogleSignIn;
        }
        async function update(){
          try {
            var user = (window.firebase && firebase.auth) ? firebase.auth().currentUser : null;
            toggle(qs('loginFab'), !user);
          } catch (e) {}
        }
        async function init(){
          bind();
          // Captura resultado de redirect y toma el Google ID token si viene
          try {
            if (window.firebase && firebase.auth && typeof firebase.auth().getRedirectResult === 'function') {
              var result = await firebase.auth().getRedirectResult();
              try {
                var cred = firebase.auth.GoogleAuthProvider.credentialFromResult(result);
                storeOAuthIdTokenFromCredential(cred);
              } catch(_) {}
            }
          } catch(_) {}
          update();
          try { if (window.firebase && firebase.auth) firebase.auth().onAuthStateChanged(function(){ update(); }); } catch(e) {}
        }
        if (document.readyState === 'complete') init(); else window.addEventListener('load', init);
      })();
    </script>

    <script>
      // Bridge Firebase Auth -> UI (login/dashboard) para admins y usuarios
      (function(){
        function qs(id){ return document.getElementById(id); }
        function toggle(el, show){ if (!el) return; if (show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        // El backend espera un Google ID Token (aud = cliente OAuth), no el Firebase ID token.
        // Por eso, no pasamos getIdToken() aquí. Ese token se captura en el flujo de login (popup/redirect) y se guarda vía setAuthToken().
        function mapUser(u){
          if (!u) return null;
          var email = u.email || '';
          return {
            name: u.displayName || (email ? email.split('@')[0] : 'Usuario'),
            email: email,
            picture: u.photoURL || null,
            domain: email.split('@')[1] || ''
          };
        }
        async function applyUserToUI(u){
          try {
            var isLogged = !!u;
            // Update globals for existing UI functions
            window.currentUser = mapUser(u);
            // Bind UI
            if (isLogged) {
              try { qs('userNameDisplay').textContent = window.currentUser.name; } catch(e){}
              try { qs('userEmailDisplay').textContent = window.currentUser.email; } catch(e){}
            }
            toggle(qs('loginPage'), !isLogged);
            toggle(qs('mainDashboard'), !!isLogged);
            if (isLogged) {
              // Token ya se guardó si venimos de popup/redirect. Si no hay token, evitamos enviar uno inválido al backend.
              if (typeof initializeApp === 'function') initializeApp();
              if (typeof startAutoRefresh === 'function') startAutoRefresh();
            }
          } catch (e) { console && console.warn && console.warn('Auth->UI error', e); }
        }
        function setup(){
          if (window.firebase && firebase.auth) {
            try { firebase.auth().onAuthStateChanged(applyUserToUI); } catch(e){}
            try { applyUserToUI(firebase.auth().currentUser || null); } catch(e){}
          }
        }
        if (document.readyState === 'complete') setup(); else window.addEventListener('load', setup);
        // Expose for debugging
        window.__applyUserToUI = applyUserToUI;
      })();
    </script>

    <!-- Health Check minimal (Firebase) -->
    <div id="healthCheckCard" class="fixed bottom-4 right-4 bg-white border border-gray-200 rounded-lg shadow p-3 text-sm z-50">
      <div class="flex items-center justify-between mb-2">
        <span class="font-medium text-gray-800">Health Check</span>
        <button id="hc-close" aria-label="Ocultar" class="text-gray-400 hover:text-gray-600">✕</button>
      </div>
      <div id="hc-status" class="space-y-1 text-gray-700">
        <div><span class="inline-block w-2 h-2 rounded-full align-middle mr-2 bg-gray-300" id="hc-sdk-dot"></span>SDK: <span id="hc-sdk">pendiente</span></div>
        <div><span class="inline-block w-2 h-2 rounded-full align-middle mr-2 bg-gray-300" id="hc-app-dot"></span>App: <span id="hc-app">pendiente</span></div>
        <div><span class="inline-block w-2 h-2 rounded-full align-middle mr-2 bg-gray-300" id="hc-auth-dot"></span>Auth: <span id="hc-auth">pendiente</span></div>
        <div><span class="inline-block w-2 h-2 rounded-full align-middle mr-2 bg-gray-300" id="hc-db-dot"></span>Firestore: <span id="hc-db">pendiente</span></div>
      </div>
      <div class="mt-2 flex gap-2">
        <button id="hc-run" class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700">Probar</button>
        <button id="hc-hide" class="px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Ocultar</button>
      </div>
    </div>

    <script>
      (function(){
        function setDot(id, ok){
          var el = document.getElementById(id);
          if (!el) return;
          el.classList.remove("bg-gray-300","bg-red-500","bg-green-500","bg-yellow-400");
          el.classList.add(ok === true ? "bg-green-500" : ok === false ? "bg-red-500" : "bg-yellow-400");
        }
        function setText(id, text){ var el = document.getElementById(id); if (el) el.textContent = text; }
        async function run(){
          try {
            var sdkLoaded = !!window.firebase;
            setDot('hc-sdk-dot', sdkLoaded);
            setText('hc-sdk', sdkLoaded ? 'cargado' : 'no cargado');

            var initialized = false;
            try { initialized = sdkLoaded && firebase.apps && firebase.apps.length > 0; } catch(e){}
            setDot('hc-app-dot', initialized);
            setText('hc-app', initialized ? 'inicializado' : 'no inicializado');

            var authApi = false;
            try { authApi = sdkLoaded && !!firebase.auth; } catch(e){}
            var user = null;
            try { user = authApi ? firebase.auth().currentUser : null; } catch(e){}
            // Punto: verde si sesión iniciada, amarillo si API disponible pero no logueado, rojo si no hay API
            setDot('hc-auth-dot', user ? true : (authApi ? null : false));
            setText('hc-auth', user ? 'sesión iniciada' : (authApi ? 'sesión no iniciada' : 'no disponible'));

            // Firestore: solo probar si hay sesión iniciada
            var dbStatusText = user ? 'probando...' : 'requiere inicio de sesión';
            var dbOk = null; // amarillo por defecto
            try {
              if (sdkLoaded && firebase.firestore) {
                if (user) {
                  var db = firebase.firestore();
                  var snap = await db.collection('health_check').doc('hc').get();
                  dbOk = true;
                  dbStatusText = snap.exists ? 'lectura OK (doc existe)' : 'lectura OK (doc no existe)';
                } else {
                  dbOk = null; // no probar sin sesión
                }
              } else {
                dbOk = false; dbStatusText = 'no disponible';
              }
            } catch(e) {
              dbOk = false;
              dbStatusText = (e && e.code) ? ('error ' + e.code) : 'error';
            }
            setDot('hc-db-dot', dbOk);
            setText('hc-db', dbStatusText);
          } catch (e) {
            console.warn('Health check error', e);
          }
        }
        function hide(){ var c = document.getElementById('healthCheckCard'); if (c) c.style.display = 'none'; }
        function show(){ var c = document.getElementById('healthCheckCard'); if (c) c.style.display = ''; }
        window.runHealthCheck = run;
        window.showHealthCheck = show;
        var btn = document.getElementById('hc-run'); if (btn) btn.addEventListener('click', run);
        var hideBtn = document.getElementById('hc-hide'); if (hideBtn) hideBtn.addEventListener('click', hide);
        var closeBtn = document.getElementById('hc-close'); if (closeBtn) closeBtn.addEventListener('click', hide);
        // Ejecuta una vez al cargar y al cambiar la sesión
        function schedule(){ setTimeout(run, 300); }
        if (document.readyState === 'complete') { schedule(); } else { window.addEventListener('load', schedule); }
        try {
          if (window.firebase && firebase.auth) {
            firebase.auth().onAuthStateChanged(schedule);
          }
        } catch(e) {}
      })();
    </script>
    <!-- Login Page -->
    <div
      id="loginPage"
      class="login-container flex items-center justify-center relative"
    >
      <!-- Floating Background Shapes -->
      <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
      </div>

      <!-- Login Card -->
      <div
        class="login-card rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 relative z-10"
      >
        <!-- Logo and Title -->
        <div class="text-center mb-8">
          <div
            class="bg-gradient-to-r from-primary-600 to-primary-500 p-4 rounded-full w-20 h-20 mx-auto mb-4 pulse-animation"
          >
            <i class="fas fa-graduation-cap text-white text-3xl mt-2"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">EduControl Pro</h1>
          <p class="text-gray-600">Sistema de Control Académico</p>
          <div
            class="w-16 h-1 bg-gradient-to-r from-primary-500 to-primary-600 mx-auto mt-4 rounded-full"
          ></div>
        </div>

        <!-- Institution Info -->
        <div
          class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 mb-6 border border-blue-100"
        >
          <div class="flex items-center space-x-3">
            <div class="bg-blue-500 p-2 rounded-lg">
              <i class="fas fa-university text-white"></i>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900">Acceso Institucional</h3>
              <p class="text-sm text-gray-600">Solo para personal autorizado</p>
            </div>
          </div>
        </div>

        <!-- Login Instructions -->
        <div class="mb-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-3">
            Iniciar Sesión
          </h2>
          <p class="text-gray-600 text-sm mb-4">
            Utiliza tu cuenta institucional de Google para acceder al sistema de
            control académico.
          </p>

          <!-- Requirements -->
          <div
            class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4"
          >
            <div class="flex items-start space-x-2">
              <i class="fas fa-info-circle text-yellow-600 mt-0.5"></i>
              <div>
                <p class="text-sm text-yellow-800 font-medium">Requisitos:</p>
                <ul class="text-xs text-yellow-700 mt-1 space-y-1">
                  <li>• Cuenta de Google del dominio institucional</li>
                  <li>• Permisos de acceso al sistema</li>
                  <li>• Conexión a internet estable</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Google Sign-In Button -->
        <div class="mb-6">
          

          <!-- Botón alternativo por redirección (evita bloqueos FedCM/incógnito) -->
          <button
            onclick="robustGoogleSignIn()"
            class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-xl flex items-center justify-center space-x-3"
          >
            <i class="fa-brands fa-google"></i>
            <span>Iniciar sesión con Google (alternativa)</span>
          </button>

          <!-- Alternative Manual Login (Demo) -->
          <div id="demoAccessBlock" class="mt-4 text-center">
            <p class="text-xs text-gray-500 mb-3">
              ¿Problemas con Google? Usa el acceso de demostración:
            </p>
            <button
              onclick="demoLogin()"
              class="text-primary-600 hover:text-primary-700 text-sm font-medium underline"
            >
              Acceso Demo (Solo para pruebas)
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="loginLoading" class="hidden text-center py-4">
          <div class="loading-spinner mx-auto mb-3"></div>
          <p class="text-gray-600 text-sm">Verificando credenciales...</p>
        </div>

        <!-- Error Message -->
        <div
          id="loginError"
          class="hidden bg-red-50 border border-red-200 rounded-lg p-3 mb-4"
        >
          <div class="flex items-center space-x-2">
            <i class="fas fa-exclamation-triangle text-red-600"></i>
            <p class="text-sm text-red-800" id="loginErrorMessage"></p>
          </div>
        </div>

        <!-- Footer -->
        <div class="text-center pt-6 border-t border-gray-200">
          <p class="text-xs text-gray-500">
            © 2024 EduControl Pro. Sistema Académico Institucional
          </p>
          <div class="flex justify-center space-x-4 mt-2">
            <a href="#" class="text-xs text-gray-400 hover:text-gray-600"
              >Soporte</a
            >
            <a href="#" class="text-xs text-gray-400 hover:text-gray-600"
              >Privacidad</a
            >
            <a href="#" class="text-xs text-gray-400 hover:text-gray-600"
              >Términos</a
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Main Dashboard (Hidden initially) -->
    <div id="mainDashboard" class="hidden">
      <!-- Navigation Header -->
      <nav
        class="bg-gradient-to-r from-primary-600 to-primary-500 shadow-lg relative z-50"
      >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16">
            <!-- Logo and Title -->
            <div class="flex items-center space-x-4">
              <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                <i class="fas fa-graduation-cap text-white text-xl"></i>
              </div>
              <div>
                <h1 class="text-white text-lg font-bold">EduControl Pro</h1>
                <p class="text-green-100 text-xs">Sistema Académico</p>
              </div>
            </div>

            <!-- Desktop Navigation -->
            <div class="hidden lg:flex items-center space-x-6">
              <button
                onclick="showSection('dashboard')"
                class="nav-btn text-white hover:text-green-200 px-3 py-2 rounded-lg transition-colors active"
              >
                <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
              </button>
              <button
                onclick="showSection('teachers')"
                class="nav-btn text-white hover:text-green-200 px-3 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-users mr-2"></i>Docentes
              </button>
              <button
                onclick="showSection('reports')"
                class="nav-btn text-white hover:text-green-200 px-3 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-chart-bar mr-2"></i>Reportes
              </button>
            </div>

            <!-- Desktop Actions -->
            <div class="hidden lg:flex items-center space-x-3">
              <button
                onclick="logout()"
                class="bg-red-500 bg-opacity-80 hover:bg-opacity-100 text-white px-4 py-2 rounded-lg transition-all"
              >
                <i class="fas fa-sign-out-alt mr-2"></i>Salir
              </button>
              <div class="flex items-center space-x-3 ml-4">
                <div class="bg-white bg-opacity-20 rounded-full p-2">
                  <i class="fas fa-user text-white"></i>
                </div>
                <div class="text-white text-right">
                  <p class="text-sm font-medium" id="userNameDisplay">Usuario</p>
                  <p class="text-xs text-green-100" id="userEmailDisplay">usuario@institucion.edu</p>
                </div>
              </div>
            </div>

            <!-- Mobile Menu Button -->
            <div class="lg:hidden">
              <button
                id="mobileMenuBtn"
                onclick="toggleMobileMenu()"
                class="text-white p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all"
              >
                <i class="fas fa-bars text-xl"></i>
              </button>
            </div>
          </div>
        </div>
      </nav>

      <!-- Mobile Menu Overlay -->
      <div
        id="mobileMenuOverlay"
        class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"
      ></div>

      <!-- Mobile Menu -->
      <div
        id="mobileMenu"
        class="mobile-menu mobile-menu-closed fixed top-0 left-0 h-full w-80 bg-white shadow-2xl z-50 lg:hidden"
      >
        <div class="p-6">
          <!-- Mobile Menu Header -->
          <div class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-3">
              <div class="bg-primary-500 p-2 rounded-lg">
                <i class="fas fa-graduation-cap text-white"></i>
              </div>
              <div>
                <h2 class="text-gray-900 font-bold">EduControl Pro</h2>
                <p class="text-gray-500 text-sm">Menú Principal</p>
              </div>
            </div>
            <button
              onclick="closeMobileMenu()"
              class="text-gray-400 hover:text-gray-600 p-2"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Navigation Links -->
          <div class="space-y-2 mb-8">
            <h3
              class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-3"
            >
              Navegación
            </h3>
            <button
              onclick="showSection('dashboard'); closeMobileMenu();"
              class="w-full text-left flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors"
            >
              <div class="bg-blue-100 p-2 rounded-lg">
                <i class="fas fa-tachometer-alt text-blue-600"></i>
              </div>
              <div>
                <span class="text-gray-900 font-medium">Dashboard</span>
                <p class="text-gray-500 text-sm">Panel principal</p>
              </div>
            </button>
            <button
              onclick="showSection('teachers'); closeMobileMenu();"
              class="w-full text-left flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors"
            >
              <div class="bg-green-100 p-2 rounded-lg">
                <i class="fas fa-users text-green-600"></i>
              </div>
              <div>
                <span class="text-gray-900 font-medium">Docentes</span>
                <p class="text-gray-500 text-sm">Gestión de profesores</p>
              </div>
            </button>
            <button
              onclick="showSection('reports'); closeMobileMenu();"
              class="w-full text-left flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors"
            >
              <div class="bg-purple-100 p-2 rounded-lg">
                <i class="fas fa-chart-bar text-purple-600"></i>
              </div>
              <div>
                <span class="text-gray-900 font-medium">Reportes</span>
                <p class="text-gray-500 text-sm">Análisis y estadísticas</p>
              </div>
            </button>
          </div>

          <!-- Quick Actions -->
          <div class="space-y-2 mb-8">
            <h3
              class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-3"
            >
              Acciones Rápidas
            </h3>
              <div class="grid grid-cols-2 gap-3">
                <button
                  onclick="openActivitiesModal(); closeMobileMenu();"
                  class="bg-blue-50 hover:bg-blue-100 text-blue-700 p-4 rounded-lg transition-colors flex flex-col items-center space-y-2"
                >
                  <i class="fas fa-tasks text-xl"></i>
                  <span class="text-sm font-medium">Actividades</span>
                </button>
                
              </div>
          </div>

          <!-- Search -->
          <div class="space-y-2 mb-8">
            <h3
              class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-3"
            >
              Búsqueda
            </h3>
            <div class="relative">
              <input
                type="text"
                placeholder="Buscar docentes..."
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              />
              <i
                class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
              ></i>
            </div>
          </div>

          <!-- Stats Summary -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h3
              class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-3"
            >
              Resumen
            </h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center">
                <div
                  class="text-2xl font-bold text-primary-600"
                  id="mobileStatsTeachers"
                >
                  0
                </div>
                <div class="text-xs text-gray-500">Docentes</div>
              </div>
              <div class="text-center">
                <div
                  class="text-2xl font-bold text-green-600"
                  id="mobileStatsCompleted"
                >
                  0
                </div>
                <div class="text-xs text-gray-500">Completadas</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Activities Preview (read-only) -->
        <div class="mt-8">
          <div class="bg-white rounded-xl shadow-lg p-6 animate-fade-in" style="animation-delay: 0.6s">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-900">Vista de Actividades (solo lectura)</h3>
              <span class="text-xs text-gray-500">Estado por docente y actividad</span>
            </div>    <script>
      function renderActivitiesPreview() {
        try {
          const container = document.getElementById('activitiesPreview');
          if (!container) return;
          container.innerHTML = '';
          if (!Array.isArray(teachers) || !Array.isArray(activities) || teachers.length === 0 || activities.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500" title="Sin actividades configuradas o sin datos disponibles">Sin datos para mostrar.</p>';
            return;
          }
          const MAX_ROWS = 12; // limit to avoid very long page
          const list = (typeof filteredTeachers !== 'undefined' && filteredTeachers && filteredTeachers.length) ? filteredTeachers : teachers;
          const rows = list.slice(0, MAX_ROWS);
          rows.forEach(t => {
            const row = document.createElement('div');
            row.className = 'p-4 rounded-lg border bg-gray-50';
            const title = document.createElement('div');
            title.className = 'flex items-center justify-between mb-3';
            title.innerHTML = '<div><div class="text-sm font-semibold text-gray-800"></div><div class="text-xs text-gray-600"></div></div>';
            const chips = document.createElement('div');
            chips.className = 'flex flex-wrap gap-2';
            activities.forEach(a => {
              const ok = getActivityState(t, a);
              const chip = document.createElement('span');
              chip.className = 'px-2 py-1 rounded text-xs inline-flex items-center ' + (ok ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-gray-100 text-gray-600 border border-gray-200');
              chip.innerHTML = `<i class="fas ${ok ? 'fa-check-circle text-green-600' : 'fa-times-circle text-gray-400'} mr-1"></i>${a}`;
              chip.title = ok ? 'Completada' : 'No completada';
              chip.setAttribute('aria-label', chip.title); try { chip.style.cursor = 'pointer'; chip.addEventListener('click', function(){ openActivityDetail(t.id, a); }); } catch(e) {}
              chips.appendChild(chip);
            });
            row.appendChild(title);
            row.appendChild(chips);
            container.appendChild(row);
          });
          if (list.length > MAX_ROWS) {
            const note = document.createElement('div');
            note.className = 'text-xs text-gray-500';
            note.textContent = "Mostrando de docentes.";
            container.appendChild(note);
          }
        } catch (e) { console.warn('preview render error', e); }
      }
    </script>
            <div id="activitiesPreview" class="space-y-4"></div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section active">
          <!-- Recent Teachers Preview -->
          <div class="bg-white rounded-xl shadow-lg p-6 card-hover mb-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-900">Últimos docentes registrados</h3>
              <span class="text-xs text-gray-500">Resumen rápido</span>
            </div>
            <div id="recentTeachersPreview" class="divide-y divide-gray-100"></div>
          </div>
          <!-- Stats Cards -->
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
          >
            <div
              class="bg-white rounded-xl shadow-lg p-6 card-hover animate-fade-in"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-medium">
                    Total Docentes
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900"
                    id="totalTeachers"
                  >
                    0
                  </p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                  <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
              </div>
              <div class="mt-4">
                <span class="text-green-600 text-sm font-medium"
                  >+5% este mes</span
                >
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-lg p-6 card-hover animate-fade-in"
              style="animation-delay: 0.1s"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-medium">
                    Actividades Completadas
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900"
                    id="completedActivities"
                  >
                    0
                  </p>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                  <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
              </div>
              <div class="mt-4">
                <span class="text-green-600 text-sm font-medium"
                  >Excelente progreso</span
                >
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-lg p-6 card-hover animate-fade-in"
              style="animation-delay: 0.2s"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-medium">
                    Promedio Completitud
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900"
                    id="averageCompletion"
                  >
                    0%
                  </p>
                </div>
                <div class="bg-yellow-100 p-3 rounded-full">
                  <i class="fas fa-percentage text-yellow-600 text-xl"></i>
                </div>
              </div>
              <div class="mt-4">
                <span class="text-yellow-600 text-sm font-medium"
                  >En progreso</span
                >
              </div>
            </div>

            <div
              class="bg-white rounded-xl shadow-lg p-6 card-hover animate-fade-in"
              style="animation-delay: 0.3s"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm font-medium">
                    Actividades Pendientes
                  </p>
                  <p
                    class="text-3xl font-bold text-gray-900"
                    id="pendingActivities"
                  >
                    0
                  </p>
                </div>
                <div class="bg-red-100 p-3 rounded-full">
                  <i class="fas fa-clock text-red-600 text-xl"></i>
                </div>
              </div>
              <div class="mt-4">
                <span class="text-red-600 text-sm font-medium"
                  >Requiere atención</span
                >
              </div>
            </div>
          </div>

          <!-- Main Dashboard Content -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Teachers Table -->
            <div class="lg:col-span-2">
              <div
                class="bg-white rounded-xl shadow-lg p-6 animate-fade-in"
                style="animation-delay: 0.4s"
              >
                <div
                  class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0"
                >
                  <div>
                    <h2 class="text-2xl font-bold text-gray-900">
                      Gestión de Docentes
                    </h2>
                    <p class="text-gray-600">
                      Administra el seguimiento académico
                    </p>
                  </div>
                  <div class="flex flex-wrap gap-2">
                    <button
                      onclick="openActivitiesModal()"
                      class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
                    >
                      <i class="fas fa-tasks mr-2"></i>Actividades
                    </button>
                    
                  </div>
                </div>

                
              </div>
            </div>

            <!-- Charts (centered below main content) -->
            <div class="lg:col-span-3">
              <div
                class="bg-white rounded-xl shadow-lg p-6 animate-fade-in"
                style="animation-delay: 0.5s"
              >
                <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-gray-900">
                    Estadísticas de Progreso
                  </h3>
                  <div class="flex space-x-2">
                    <button
                      onclick="showChartType('individual')"
                      id="individualBtn"
                      class="chart-type-btn active px-3 py-1 text-sm rounded-lg bg-primary-500 text-white"
                    >
                      Individual
                    </button>
                    <button
                      onclick="showChartType('general')"
                      id="generalBtn"
                      class="chart-type-btn px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-700"
                    >
                      General
                    </button>
                  </div>
                </div>

                <div id="chartsContainer">
                  <div id="noChartsMessage" class="text-center py-8">
                    <i class="fas fa-chart-pie text-gray-300 text-4xl mb-4"></i>
                    <p class="text-gray-500">
                      No hay datos suficientes para mostrar gráficos
                    </p>
                  </div>

                  <!-- Individual Charts Container -->
                  <div id="individualChartsContainer" class="space-y-6">
                    <!-- Individual teacher charts will be generated here -->
                  </div>

                  <!-- General Chart Container -->
                  <div id="generalChartContainer" class="hidden">
                    <div class="mb-4">
                      <h4 class="text-lg font-semibold text-gray-800 mb-2">
                        Progreso General del Sistema
                      </h4>
                      <p class="text-sm text-gray-600">
                        Distribución de completitud de actividades
                      </p>
                    </div>
                  <div class="w-full"><canvas id="generalProgressChart" class="w-full" style="height: 360px;"></canvas></div>
                    <div
                      id="generalStats"
                      class="mt-4 grid grid-cols-2 gap-4 text-center"
                    >
                      <!-- General statistics will be populated here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Teachers Section -->
        <div id="teachersSection" class="section hidden">
          <div class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-center justify-between mb-8">
              <div>
                <h2 class="text-3xl font-bold text-gray-900">
                  Gestión de Docentes
                </h2>
                <p class="text-gray-600 mt-2">
                  Vista completa de todos los docentes
                </p>
              </div>
            <div class="flex flex-wrap gap-2">
              <button onclick="openAddModal()" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-plus mr-2"></i>Nuevo
              </button>
              <button onclick="openActivitiesModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-tasks mr-2"></i>Actividades
              </button>
              <button
                onclick="deleteSelected()"
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-trash mr-2"></i>Eliminar seleccionados
              </button>
              <button
                onclick="showSection('dashboard')"
                class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg transition-colors"
              >
                <i class="fas fa-arrow-left mr-2"></i>Volver al Dashboard
              </button>
            </div>
            </div>
            <div class="flex flex-col gap-6">
              <div class="flex flex-wrap items-center gap-3">
                <button onclick="openImportDialog()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg border">
                  <i class="fas fa-file-import mr-2"></i>Importar Excel
                </button>
                <button onclick="exportTeachersToExcel()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg border">
                  <i class="fas fa-file-export mr-2"></i>Exportar Excel
                </button>
                <button onclick="openSubjectsModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                  <i class="fas fa-book mr-2"></i>Perfil de Materias
                </button>
                <div class="ml-auto flex items-center gap-2">
                  <label for="subjectFilter" class="text-gray-600 text-sm">Materia:</label>
                  <select id="subjectFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <option value="">Todas</option>
                  </select>
                </div>
              </div>
              <input id="teachersImportInput" type="file" accept=".xlsx,.xls" class="hidden" />
              <div class="text-gray-500">Usa la tabla principal para seleccionar docentes y aplicar acciones; o importa/exporta usando los botones.</div>
            </div>

            <!-- Search and Filters -->
            <div class="mb-6">
              <div class="relative">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Buscar por ID, nombre o apellidos..."
                  onkeyup="filterTable()"
                  class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                />
                <i
                  class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                ></i>
              </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
              <div class="loading-spinner mx-auto mb-4"></div>
              <p class="text-gray-500">Cargando datos...</p>
            </div>

            <!-- Teachers Table -->
            <div id="tableContainer" class="hidden overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr id="tableHeader">
                    <!-- Headers will be generated dynamically -->
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <!-- Rows will be generated dynamically -->
                </tbody>
              </table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
              <i class="fas fa-users text-gray-300 text-6xl mb-4"></i>
              <p class="text-gray-500 text-lg">
                No hay docentes registrados
              </p>
              <button
                onclick="openAddModal()"
                class="mt-4 bg-primary-500 hover:bg-primary-600 text-white px-6 py-3 rounded-lg transition-colors"
              >
                <i class="fas fa-plus mr-2"></i>Agregar Primer Docente
              </button>
            </div>
          </div>
        </div>

        <!-- Reports Section -->
        <div id="reportsSection" class="section hidden">
          <div class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-center justify-between mb-8">
              <div>
                <h2 class="text-3xl font-bold text-gray-900">
                  Reportes y Análisis
                </h2>
                <p class="text-gray-600 mt-2">
                  Informes detallados y estadísticas
                </p>
              </div>
              <button
                onclick="showSection('dashboard')"
                class="bg-primary-500 hover:bg-primary-600 text-white px-6 py-3 rounded-lg transition-colors"
              >
                <i class="fas fa-arrow-left mr-2"></i>Volver al Dashboard
              </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div
                class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200"
              >
                <div class="flex items-center space-x-3 mb-4">
                  <div class="bg-blue-500 p-2 rounded-lg">
                    <i class="fas fa-file-pdf text-white"></i>
                  </div>
                  <h3 class="text-lg font-bold text-blue-800">
                    Reporte General
                  </h3>
                </div>
                <p class="text-blue-600 text-sm mb-4">
                  Resumen completo de todos los docentes y actividades
                </p>
                <button
                  onclick="generateReport()"
                  class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
                >
                  Generar PDF
                </button>
              </div>

              <div
                class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200"
              >
                <div class="flex items-center space-x-3 mb-4">
                  <div class="bg-green-500 p-2 rounded-lg">
                    <i class="fas fa-chart-line text-white"></i>
                  </div>
                  <h3 class="text-lg font-bold text-green-800">
                    Análisis de Progreso
                  </h3>
                </div>
                <p class="text-green-600 text-sm mb-4">
                  Estadísticas detalladas de completitud por actividad
                </p>
                <button
                  class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                >
                  Ver Análisis
                </button>
              </div>

              <div
                class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200"
              >
                <div class="flex items-center space-x-3 mb-4">
                  <div class="bg-purple-500 p-2 rounded-lg">
                    <i class="fas fa-calendar-alt text-white"></i>
                  </div>
                  <h3 class="text-lg font-bold text-purple-800">
                    Reporte Mensual
                  </h3>
                </div>
                <p class="text-purple-600 text-sm mb-4">
                  Resumen de actividades del mes actual
                </p>
                <button
                  class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors"
                >
                  Generar Mensual
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Teacher Modal -->
      <div
        id="addModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
      >
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">Nuevo Docente</h3>
            <button
              onclick="closeAddModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <form id="addTeacherForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >ID del Docente</label
              >
              <input
                type="text"
                id="newTeacherId"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                placeholder="Ej: DOC001"
              />
              <div id="idError" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Nombre</label
              >
              <input
                type="text"
                id="newTeacherName"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                placeholder="Nombre del docente"
              />
              <div
                id="nameError"
                class="text-red-600 text-sm mt-1 hidden"
              ></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Apellidos</label
              >
              <input
                type="text"
                id="newTeacherLastName"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                placeholder="Apellidos del docente"
              />
              <div
                id="lastNameError"
                class="text-red-600 text-sm mt-1 hidden"
              ></div>
            </div>

            <div class="flex gap-3 pt-4">
              <button
                type="button"
                onclick="closeAddModal()"
                class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors"
              >
                Cancelar
              </button>
              <button
                type="button"
                onclick="addNewTeacher()"
                class="flex-1 px-4 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-colors"
              >
                Guardar
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Activities Modal -->
      <div
        id="activitiesModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
      >
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">
              Gestionar Actividades
            </h3>
            <button
              onclick="closeActivitiesModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <div class="max-h-60 overflow-y-auto mb-6">
            <div id="activitiesList" class="space-y-2">
              <!-- Activities will be populated here -->
            </div>
          </div>
          <!-- Sección de agregar nueva actividad eliminada -->

          <div class="flex gap-3 pt-6">
            <button
              onclick="closeActivitiesModal()"
              class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors"
            >
              Cerrar
            </button>
            <button
              onclick="saveActivities()"
              class="flex-1 px-4 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-colors"
            >
              Guardar Cambios
            </button>
          </div>
        </div>
      </div>

      <!-- Subjects Modal -->
      <div
        id="subjectsModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
      >
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">
              Materias de <span id="subjectsTeacherLabel" class="text-primary-600"></span>
            </h3>
            <button onclick="closeSubjectsModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="mb-4 text-sm text-gray-600">
            <span class="font-medium">ID:</span> <span id="subjectsTeacherId"></span>
          </div>
          <div class="max-h-60 overflow-y-auto mb-4">
            <ul id="subjectsList" class="space-y-2"></ul>
          </div>
          <div class="flex gap-3">
            <input type="text" id="newSubjectInput" placeholder="Nueva materia" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" />
            <button onclick="addSubjectToList()" class="bg-primary-500 hover:bg-primary-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
              <i class="fas fa-plus mr-2"></i>Agregar
            </button>
          </div>
          <div class="flex gap-3 pt-6">
            <button onclick="closeSubjectsModal()" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors">Cerrar</button>
            <button onclick="saveSubjectsForCurrentTeacher()" class="flex-1 px-4 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-colors">Guardar</button>
          </div>
        </div>
      </div>

      <!-- Notification Container -->
      <div
        id="notificationContainer"
        class="fixed top-4 right-4 z-50 space-y-2"
      ></div>
    </div>
    <!-- End Main Dashboard -->

    <script>
      // Authentication and Login Functions
      let currentUser = null;
      const DEMO_ENABLED = false; // Oculta/bloquea el acceso demo cuando es false

      // Decode Google ID token payload (removed)
      function parseJwt(token) { return null; }

      // Initialize Google Sign-In (removed)
      function initializeGoogleSignIn() {}

      // Handle Google Sign-In response (removed)
      function handleCredentialResponse() {}

      // Validate institutional email domain (removed)
      function validateInstitutionalEmail(email) { return true; }

      // Initiate Google Sign-In
      function initiateGoogleSignIn() {
        hideLoginError();

        if (typeof google !== "undefined" && google.accounts) {
          google.accounts.id.prompt((notification) => {
            if (
              notification.isNotDisplayed() ||
              notification.isSkippedMoment()
            ) {
              // Fallback: show manual sign-in
              showLoginError(
                "No se pudo mostrar el diálogo de Google. Use el acceso demo o verifique su conexión."
              );
            }
          });
        } else {
          showLoginError(
            "Google Sign-In no está disponible. Use el acceso demo para continuar."
          );
        }
      }

      // Demo login (for testing purposes)
      function demoLogin() {
        if (!DEMO_ENABLED) {
          showLoginError(
            "El acceso de demostración está deshabilitado por la institución."
          );
          return;
        }
        showLoginLoading(true);
        hideLoginError();

        // Simulate demo user
        currentUser = {
          name: "Usuario Demo",
          email: "demo@institucion.edu",
          picture: null,
          domain: "institucion.edu",
          isDemo: true,
        };

        setTimeout(() => {
          showLoginLoading(false);
          loginSuccess();
        }, 2000);
      }

      // Login success
      function loginSuccess() {
        // Update user display
        document.getElementById("userNameDisplay").textContent =
          currentUser.name;
        document.getElementById("userEmailDisplay").textContent =
          currentUser.email;

        // Hide login page and show dashboard
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("mainDashboard").classList.remove("hidden");

        // Initialize the main application
        initializeApp();
        // Start periodic auto-refresh
        if (typeof startAutoRefresh === "function") startAutoRefresh();

        // Show welcome notification
        setTimeout(() => {
          showNotification(`¡Bienvenido, ${currentUser.name}!`, "success");
        }, 500);
      }

      // Logout function
      function logout() {
        if (confirm("¿Está seguro de que desea cerrar sesión?")) {
          // Clear user data
          currentUser = null;

          // Reset Google Sign-In
          if (typeof google !== "undefined" && google.accounts) {
            google.accounts.id.disableAutoSelect();
          }
          try { if (window.firebase && firebase.auth) { firebase.auth().signOut(); } } catch (e) {}

          // Show login page and hide dashboard
          document.getElementById("mainDashboard").classList.add("hidden");
          document.getElementById("loginPage").classList.remove("hidden");

          // Reset any form states
          hideLoginError();
          showLoginLoading(false);

          showNotification("Sesión cerrada exitosamente", "success");
        }
      }

      // Show/hide login loading state
      function showLoginLoading(show) {
        const loadingElement = document.getElementById("loginLoading");
        const buttonElements = document.querySelectorAll("#loginPage button");

        if (show) {
          loadingElement.classList.remove("hidden");
          buttonElements.forEach((btn) => (btn.disabled = true));
        } else {
          loadingElement.classList.add("hidden");
          buttonElements.forEach((btn) => (btn.disabled = false));
        }
      }

      // Show login error
      function showLoginError(message) {
        const errorElement = document.getElementById("loginError");
        const messageElement = document.getElementById("loginErrorMessage");

        messageElement.textContent = message;
        errorElement.classList.remove("hidden");
      }

      // Hide login error
      function hideLoginError() {
        document.getElementById("loginError").classList.add("hidden");
      }

      // Legacy GIS session check (removed)
      function checkExistingSession() {}

      // Global variables
      let teachers = [
        {
          id: "DOC001",
          name: "Ana",
          lastName: "García López",
          activities: {
            "Planificación de clases": true,
            "Evaluación de estudiantes": true,
            "Reuniones de padres": false,
            "Capacitación docente": true,
            "Elaboración de materiales": false,
          },
        },
        {
          id: "DOC002",
          name: "Carlos",
          lastName: "Rodríguez Martín",
          activities: {
            "Planificación de clases": true,
            "Evaluación de estudiantes": false,
            "Reuniones de padres": true,
            "Capacitación docente": false,
            "Elaboración de materiales": true,
          },
        },
        {
          id: "DOC003",
          name: "María",
          lastName: "Fernández Silva",
          activities: {
            "Planificación de clases": true,
            "Evaluación de estudiantes": true,
            "Reuniones de padres": true,
            "Capacitación docente": true,
            "Elaboración de materiales": true,
          },
        },
      ];

      let activities = [
        "Planificación de clases",
        "Evaluación de estudiantes",
        "Reuniones de padres",
        "Capacitación docente",
        "Elaboración de materiales",
      ];

      let filteredTeachers = [...teachers];
      let subjectsById = {}; // { [id]: string[] }
      let allSubjects = [];
      let currentEditIndex = -1;

      // Mobile Menu Functions
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        const overlay = document.getElementById("mobileMenuOverlay");
        const menuBtn = document.getElementById("mobileMenuBtn");
        const icon = menuBtn.querySelector("i");

        if (mobileMenu.classList.contains("mobile-menu-closed")) {
          // Open menu
          mobileMenu.classList.remove("mobile-menu-closed");
          mobileMenu.classList.add("mobile-menu-open");
          overlay.classList.remove("hidden");
          icon.classList.remove("fa-bars");
          icon.classList.add("fa-times");
          document.body.style.overflow = "hidden";

          // Add click listener to overlay
          overlay.addEventListener("click", closeMobileMenu);
        } else {
          closeMobileMenu();
        }
      }

      function closeMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        const overlay = document.getElementById("mobileMenuOverlay");
        const menuBtn = document.getElementById("mobileMenuBtn");
        const icon = menuBtn.querySelector("i");

        mobileMenu.classList.remove("mobile-menu-open");
        mobileMenu.classList.add("mobile-menu-closed");
        overlay.classList.add("hidden");
        icon.classList.remove("fa-times");
        icon.classList.add("fa-bars");
        document.body.style.overflow = "auto";

        // Remove click listener from overlay
        overlay.removeEventListener("click", closeMobileMenu);
      }

      // Navigation Functions
      function showSection(sectionName) {
        // Hide all sections
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.add("hidden");
          section.classList.remove("active");
        });

        // Show selected section
        const targetSection = document.getElementById(sectionName + "Section");
        if (targetSection) {
          targetSection.classList.remove("hidden");
          targetSection.classList.add("active");
        }

        // Update navigation buttons
        document.querySelectorAll(".nav-btn").forEach((btn) => {
          btn.classList.remove("active", "bg-white", "bg-opacity-20");
        });

        // Add active class to current button
        const activeBtn = document.querySelector(
          `[onclick="showSection('${sectionName}')"]`
        );
        if (activeBtn && activeBtn.classList.contains("nav-btn")) {
          activeBtn.classList.add("active", "bg-white", "bg-opacity-20");
        }
      }

      // Initialize the application
      async function initializeApp() {
        try {
          showLoading("Cargando datos...");
          const resp = await api.getPagedData(1, 1000);
          if (!resp || resp.success === false) {
            console.error('getPagedData failed', resp && resp.message);
            throw new Error(resp && resp.message ? resp.message : 'No se pudo obtener datos');
          }
          teachers = Array.isArray(resp.teachers) ? resp.teachers : [];
          const headers = Array.isArray(resp.headers) ? resp.headers : [];
          activities = headers.slice(4);
          // Filtrado por rol: no-admin solo ve su propio registro
          try {
            var u = (firebase && firebase.auth && firebase.auth().currentUser) || null;
            if (typeof window.isAdminUser === 'function' && !window.isAdminUser(u)) {
              var email = (u && u.email) ? String(u.email).toLowerCase() : '';
              if (email) {
                teachers = teachers.filter(function(t){ return String(t.email||'').toLowerCase() === email; });
              } else {
                teachers = [];
              }
            }
          } catch (e) { }
          // Load subjects for all teachers and attach
          try {
            const s = await api.listAllSubjects();
            const items = (s && s.items) || [];
            subjectsById = {};
            const set = new Set();
            items.forEach(it => {
              const id = it && it.id; const arr = Array.isArray(it && it.subjects) ? it.subjects : [];
              subjectsById[id] = arr;
              arr.forEach(x => set.add(x));
            });
            allSubjects = Array.from(set).sort();
          } catch (e) { subjectsById = {}; allSubjects = []; }
          teachers.forEach(t => { t.subjects = subjectsById[t.id] || []; });
          filteredTeachers = [...teachers];

          document.getElementById("loadingState").classList.add("hidden");
          if (teachers.length === 0) {
            document.getElementById("emptyState").classList.remove("hidden");
          } else {
            document
              .getElementById("tableContainer")
              .classList.remove("hidden");
            buildTable();
          }
          updateStats();
          updateCharts();
          renderActivitiesPreview();
          renderRecentTeachersPreview();
          ensureSubjectFilterUI();
        } catch (err) {
          console.error("Error cargando datos:", err);
          document.getElementById("loadingState").classList.add("hidden");
          document.getElementById("emptyState").classList.remove("hidden");
          if (isAuthError(err)) {
            notifySessionExpired();
          } else {
            showNotification("Error al cargar datos", "error");
          }
        } finally { hideLoading(); }
      }

      // Auto-refresh configuration
      const REFRESH_INTERVAL_MS = 60000; // 60s
      const REFRESH_UPDATE_UI_MS = 1000; // 1s indicator update
      let autoRefreshTimer = null;
      let indicatorTimer = null;
      let autoRefreshPaused = false;
      let lastRefreshAt = null;

      function ensureRefreshIndicatorUI() {
        let bar = document.getElementById("refreshIndicatorBar");
        if (!bar) {
          bar = document.createElement("div");
          bar.id = "refreshIndicatorBar";
          bar.className = "fixed bottom-4 right-4 z-40 bg-white shadow-lg border border-gray-200 rounded-lg px-4 py-2 flex items-center space-x-3";
          bar.innerHTML = `
            <span id="miniRefreshSpinner" class="mini-spinner" style="display:none"></span>
            <span class="text-xs text-gray-600" id="lastRefreshText">Sin actualizar</span>
            <button id="toggleRefreshBtn" class="text-xs px-2 py-1 rounded bg-primary-500 text-white hover:bg-primary-600">Pausar</button>
          `;
          document.body.appendChild(bar);
          const btn = document.getElementById("toggleRefreshBtn");
          if (btn) btn.addEventListener("click", toggleAutoRefresh);
        }
        if (indicatorTimer) clearInterval(indicatorTimer);
        indicatorTimer = setInterval(updateRefreshIndicator, REFRESH_UPDATE_UI_MS);
        updateRefreshIndicator();
      }

      // GIS init removed

      function setLastRefreshNow() {
        lastRefreshAt = new Date();
        updateRefreshIndicator();
      }

      function updateRefreshIndicator() {
        const el = document.getElementById("lastRefreshText");
        if (!el) return;
        if (!lastRefreshAt) { el.textContent = "Sin actualizar"; return; }
        const secs = Math.floor((Date.now() - lastRefreshAt.getTime()) / 1000);
        const m = Math.floor(secs / 60);
        const s = secs % 60;
        const mm = m > 0 ? `${m}m ` : "";
        const ss = `${s}s`;
        el.textContent = `Actualizado hace ${mm}${ss}`;
        const btn = document.getElementById("toggleRefreshBtn");
        if (btn) btn.textContent = autoRefreshPaused ? "Reanudar" : "Pausar";
      }

      function toggleAutoRefresh() {
        autoRefreshPaused = !autoRefreshPaused;
        if (autoRefreshPaused) {
          stopAutoRefresh();
        } else {
          startAutoRefresh();
          setLastRefreshNow();
        }
        updateRefreshIndicator();
      }

      function startAutoRefresh() {
        stopAutoRefresh();
        ensureRefreshIndicatorUI();
        autoRefreshTimer = setInterval(async () => {
          try {
            showLoading("Actualizando datos...");
            const resp = await api.getPagedData(1, 1000);
            if (!resp || resp.success === false) throw new Error(resp && resp.message ? resp.message : 'No se pudo obtener datos');
            const mapped = mapPagedResponseToModel(resp);
            teachers = mapped.teachers;
            activities = mapped.activities;
            // reattach subjects and rebuild filtered view
            teachers.forEach(t => { t.subjects = subjectsById[t.id] || []; });
            filterTable();
            setLastRefreshNow();
          } catch (e) {
            console.error("Auto-refresh error:", e);
            if (isAuthError(e)) {
              stopAutoRefresh();
              notifySessionExpired();
            }
          } finally {
            hideLoading();
          }
        }, REFRESH_INTERVAL_MS);
      }

      // ===== Manejo de sesión/autenticación =====
      function isAuthError(err) {
        const msg = String((err && err.message) || err || '').toLowerCase();
        return (
          msg.includes('no autorizado') ||
          msg.includes('token inválido') ||
          msg.includes('token invalido') ||
          msg.includes('token expirado') ||
          msg.includes('aud inválido') ||
          msg.includes('iss inválido')
        );
      }
      function notifySessionExpired() {
        showNotification('Tu sesión ha expirado o es inválida. Inicia sesión nuevamente.', 'error');
        try {
          if (window.setAuthToken) window.setAuthToken(null);
          else if (window.api && window.api.setAuthToken) window.api.setAuthToken(null);
        } catch (e) {}
        try { stopAutoRefresh && stopAutoRefresh(); } catch(e) {}
        try {
          document.getElementById('mainDashboard').classList.add('hidden');
          document.getElementById('loginPage').classList.remove('hidden');
        } catch (e) {}
        try {
          if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
            google.accounts.id.prompt();
          }
        } catch (e) {}
      }

      function stopAutoRefresh() {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
        }
        if (indicatorTimer) {
          clearInterval(indicatorTimer);
          indicatorTimer = null;
        }
      }

      // ===== Excel Import/Export & Subjects (Teachers Section) =====
      function openImportDialog() {
        const input = document.getElementById('teachersImportInput');
        if (!input) return;
        input.value = '';
        input.onchange = handleTeachersImport;
        input.click();
      }

      async function handleTeachersImport(evt) {
        try {
          const file = evt.target.files && evt.target.files[0];
          if (!file) return;
          const data = await file.arrayBuffer();
          const wb = XLSX.read(data, { type: 'array' });
          const docentesSheet = wb.Sheets['Docentes'] || wb.Sheets[wb.SheetNames[0]];
          const docentes = XLSX.utils.sheet_to_json(docentesSheet, { defval: '' });
          // Expect columns: ID, Nombre, Apellidos
          const rows = [];
          docentes.forEach(r => {
            const id = String(r.ID || r.Id || r.id || '').trim();
            const name = String(r.Nombre || r.name || r['Nombre(s)'] || r.NombreDocente || r['Nombre Docente'] || r.Name || '').trim();
            const lastName = String(r.Apellidos || r['Apellidos Docente'] || r.lastName || r.Apellido || '').trim();
            if (id && name && lastName) rows.push({ id, name, lastName });
          });
          if (rows.length > 0) {
            await api.bulkAddOrUpdateTeachers(rows);
          }
          // Subjects from sheet "Materias" (optional)
          const materiasSheet = wb.Sheets['Materias'];
          if (materiasSheet) {
            const materiasRows = XLSX.utils.sheet_to_json(materiasSheet, { defval: '' });
            // Support two formats: (ID, Materias) comma-separated OR (ID, Materia) per row
            const map = {};
            materiasRows.forEach(r => {
              const id = String(r.ID || r.Id || r.id || '').trim();
              if (!id) return;
              if (r.Materias) {
                const arr = String(r.Materias).split(',').map(s=>s.trim()).filter(Boolean);
                map[id] = (map[id]||[]).concat(arr);
              } else if (r.Materia) {
                const s = String(r.Materia).trim();
                if (s) map[id] = (map[id]||[]).concat([s]);
              }
            });
            const items = Object.keys(map).map(id => ({ id, subjects: Array.from(new Set(map[id])) }));
            if (items.length > 0) await api.bulkSetSubjects(items);
          }
          await initializeApp();
          showNotification('Importación completada', 'success');
        } catch (e) {
          console.error(e);
          showNotification('Error al importar Excel', 'error');
        }
      }

      async function exportTeachersToExcel() {
        try {
          const resp = await api.getAllTeachersForReport();
          const headers = (resp.headers || []).slice();
          const rows = (resp.teachers || []).map(t => {
            const o = { ID: t.id, Nombre: t.name, Apellidos: t.lastName };
            headers.slice(4).forEach(h => { o[h] = t[h] ? 'Sí' : 'No'; });
            return o;
          });
          const ws1 = XLSX.utils.json_to_sheet(rows);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws1, 'Docentes');
          // Subjects sheet
          try {
            const sub = await api.listAllSubjects();
            const items = (sub && sub.items) || [];
            const flat = [];
            items.forEach(it => {
              const id = it.id; const arr = Array.isArray(it.subjects)?it.subjects:[];
              if (arr.length === 0) flat.push({ ID: id, Materias: '' });
              else flat.push({ ID: id, Materias: arr.join(', ') });
            });
            const ws2 = XLSX.utils.json_to_sheet(flat);
            XLSX.utils.book_append_sheet(wb, ws2, 'Materias');
          } catch (e) { /* ignore subjects sheet errors */ }
          XLSX.writeFile(wb, `docentes-${new Date().toISOString().slice(0,10)}.xlsx`);
        } catch (e) {
          console.error(e);
          showNotification('Error al exportar Excel', 'error');
        }
      }

      function openSubjectsModal() {
        const id = prompt('Ingresa el ID del docente para editar materias:');
        if (!id) return;
        editSubjectsForTeacher(id.trim());
      }

      async function editSubjectsForTeacher(teacherId) {
        try {
          currentSubjectsTeacherId = teacherId;
          const teacher = (teachers || []).find(t => t.id === teacherId);
          const name = teacher ? `${teacher.name} ${teacher.lastName}` : '';
          document.getElementById('subjectsTeacherLabel').textContent = name || '';
          document.getElementById('subjectsTeacherId').textContent = teacherId;
          const res = await api.getTeacherSubjects(teacherId);
          subjectsWorkingList = Array.isArray(res && res.subjects) ? res.subjects.slice() : [];
          renderSubjectsList();
          openSubjectsModalPanel();
        } catch (e) {
          console.error(e);
          showNotification('No se pudo cargar el perfil de materias', 'error');
        }
      }

      // ===== Subject filter UI =====
      function ensureSubjectFilterUI() {
        const sel = document.getElementById('subjectFilter');
        if (!sel) return;
        const current = sel.value;
        // rebuild options
        sel.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = ''; optAll.textContent = 'Todas'; sel.appendChild(optAll);
        (allSubjects || []).forEach(s => {
          const o = document.createElement('option'); o.value = s; o.textContent = s; sel.appendChild(o);
        });
        if (current && allSubjects.includes(current)) sel.value = current;
        sel.onchange = () => { filterTable(); };
      }
      function applySubjectFilterToList(list) {
        const sel = document.getElementById('subjectFilter');
        const v = sel ? sel.value : '';
        if (!v) return [...list];
        return list.filter(t => Array.isArray(t.subjects) && t.subjects.includes(v));
      }

      let currentSubjectsTeacherId = null;
      let subjectsWorkingList = [];

      // Helpers to read/write activity state regardless of data shape
      function getActivityState(t, a) {
        try {
          if (t && t.activities && typeof t.activities === 'object' && (a in t.activities)) return !!t.activities[a];
          return !!t[a];
        } catch (e) { return false; }
      }
      function setActivityState(t, a, v) {
        try {
          if (!t.activities || typeof t.activities !== 'object') t.activities = {};
          t.activities[a] = !!v;
          t[a] = !!v;
        } catch (e) {}
      }

      function openSubjectsModalPanel() {
        const m = document.getElementById('subjectsModal');
        m.classList.remove('hidden'); m.classList.add('flex');
      }
      function closeSubjectsModal() {
        const m = document.getElementById('subjectsModal');
        m.classList.add('hidden'); m.classList.remove('flex');
        currentSubjectsTeacherId = null; subjectsWorkingList = [];
      }
      function renderSubjectsList() {
        const ul = document.getElementById('subjectsList');
        ul.innerHTML = '';
        subjectsWorkingList.forEach((s, i) => {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between bg-gray-50 border rounded px-3 py-2';
          li.innerHTML = `<span class="text-gray-800">${s}</span>`;
          const btn = document.createElement('button');
          btn.className = 'text-red-600 hover:text-red-800';
          btn.innerHTML = '<i class="fas fa-times"></i>';
          btn.onclick = () => { subjectsWorkingList.splice(i,1); renderSubjectsList(); };
          li.appendChild(btn);
          ul.appendChild(li);
        });
      }
      function addSubjectToList() {
        const inp = document.getElementById('newSubjectInput');
        const v = (inp.value||'').trim();
        if (!v) return;
        if (!subjectsWorkingList.includes(v)) subjectsWorkingList.push(v);
        inp.value=''; renderSubjectsList();
      }
      async function saveSubjectsForCurrentTeacher() {
        if (!currentSubjectsTeacherId) return;
        try {
          await api.setTeacherSubjects(currentSubjectsTeacherId, subjectsWorkingList);
          await initializeApp();
          showNotification('Materias actualizadas', 'success');
          closeSubjectsModal();
        } catch (e) {
          console.error(e);
          showNotification('No se pudieron actualizar las materias', 'error');
        }
      }

      // Build the teachers table
      function buildTable() {
        const tableHeader = document.getElementById("tableHeader");
        const tableBody = document.getElementById("tableBody");

        // Clear existing content
        tableHeader.innerHTML = "";
        tableBody.innerHTML = "";

        // Build header (with admin-only columns)
        const isAdminTbl = (function(){
          try { return (typeof window.isAdminUser === 'function') && window.isAdminUser((firebase && firebase.auth && firebase.auth().currentUser)||null); } catch(e){ return false; }
        })();
        const headers = [
          "Sel.",
          "ID",
          "Nombre",
          "Apellidos",
          ...(isAdminTbl ? ["Correo", "No. Control"] : []),
          "Materias",
          ...activities,
          "Progreso",
          "Acciones",
        ];
        headers.forEach((header, index) => {
          const th = document.createElement("th");
          th.className =
            "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";

          if (index === 0) {
            // Select all checkbox
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = "selectAll";
            checkbox.className =
              "rounded border-gray-300 text-primary-600 focus:ring-primary-500";
            checkbox.addEventListener("change", function (e) {
              document.querySelectorAll(".select-row").forEach((cb) => {
                cb.checked = e.target.checked;
              });
            });
            th.appendChild(checkbox);
          } else {
            th.textContent = header;
          }

          tableHeader.appendChild(th);
        });

        // Build body
        filteredTeachers.forEach((teacher, index) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-50 transition-colors";

          // Selection checkbox
          const selectCell = document.createElement("td");
          selectCell.className = "px-6 py-4 whitespace-nowrap";
          const selectCheckbox = document.createElement("input");
          selectCheckbox.type = "checkbox";
          selectCheckbox.className =
            "select-row rounded border-gray-300 text-primary-600 focus:ring-primary-500";
          selectCheckbox.dataset.index = index;
          selectCell.appendChild(selectCheckbox);
          row.appendChild(selectCell);

          // ID cell
          const idCell = document.createElement("td");
          idCell.className =
            "px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900";
          idCell.textContent = teacher.id;
          row.appendChild(idCell);

          // Name cell
          const nameCell = document.createElement("td");
          nameCell.className =
            "px-6 py-4 whitespace-nowrap text-sm text-gray-900";
          nameCell.textContent = teacher.name;
          row.appendChild(nameCell);

          // Last name cell
          const lastNameCell = document.createElement("td");
          lastNameCell.className =
            "px-6 py-4 whitespace-nowrap text-sm text-gray-900";
          lastNameCell.textContent = teacher.lastName;
          row.appendChild(lastNameCell);

          // Admin-only columns: Correo, No. Control
          if (isAdminTbl) {
            const emailCell = document.createElement("td");
            emailCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-700";
            emailCell.textContent = (teacher.email || "-");
            row.appendChild(emailCell);

            const controlCell = document.createElement("td");
            controlCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-700";
            controlCell.textContent = (teacher.controlNumber || "-");
            row.appendChild(controlCell);
          }

          // Subjects (read-only)
          const subjectsCell = document.createElement("td");
          subjectsCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-700";
          const subs = Array.isArray(teacher.subjects) ? teacher.subjects : [];
          subjectsCell.textContent = subs.length ? subs.join(", ") : "-";
          row.appendChild(subjectsCell);

          // Activity checkboxes
          let completedCount = 0;
          activities.forEach((activity) => {
            const activityCell = document.createElement("td");
            activityCell.className = "px-6 py-4 whitespace-nowrap text-center";
            const activityCheckbox = document.createElement("input");
            activityCheckbox.type = "checkbox";
            activityCheckbox.className =
              "rounded border-gray-300 text-primary-600 focus:ring-primary-500";
            activityCheckbox.checked = getActivityState(teacher, activity) || false;
            if (activityCheckbox.checked) completedCount++;

            activityCheckbox.addEventListener("change", async function () {
              try { if (typeof window.isAdminUser === 'function' && !window.isAdminUser((firebase && firebase.auth && firebase.auth().currentUser)||null)) { this.checked = !this.checked; showNotification('Solo administradores pueden editar', 'error'); return; } } catch(_) {}
              setActivityState(teacher, activity, this.checked);
              try {
                showLoading("Actualizando actividad...");
                const colIndex = activities.indexOf(activity);
                if (teacher.originalIndex !== undefined && colIndex >= 0) {
                  await api.updateCheckboxState(
                    teacher.originalIndex,
                    colIndex,
                    this.checked
                  );
                }
              } catch (e) {
                console.error("Error actualizando checkbox:", e);
                showNotification("No se pudo guardar el cambio", "error");
              } finally { hideLoading(); }
              updateStats();
              updateCharts();
              renderActivitiesPreview();
              // Update progress cell
              const newCompletedCount = activities.filter(
                (act) => getActivityState(teacher, act)
              ).length;
              const progressPercent = (
                (newCompletedCount / activities.length) *
                100
              ).toFixed(1);
              const progressCell = row.querySelector(".progress-cell");
              progressCell.innerHTML = `
                            <div class="flex items-center">
                                <span class="text-sm font-medium text-gray-900 mr-2">${progressPercent}%</span>
                                <div class="w-16 bg-gray-200 rounded-full h-2">
                                    <div class="bg-primary-500 h-2 rounded-full progress-bar" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        `;
            });

            activityCell.appendChild(activityCheckbox);
            row.appendChild(activityCell);
          });

          // Progress cell
          const progressCell = document.createElement("td");
          progressCell.className = "px-6 py-4 whitespace-nowrap progress-cell";
          const progressPercent = (
            (completedCount / (activities.length || 1)) *
            100
          ).toFixed(1);
          progressCell.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-900 mr-2">${progressPercent}%</span>
                        <div class="w-16 bg-gray-200 rounded-full h-2">
                            <div class="bg-primary-500 h-2 rounded-full progress-bar" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                `;
          row.appendChild(progressCell);

          // Actions cell
          const actionsCell = document.createElement("td");
          actionsCell.className =
            "px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2";

          const editBtn = document.createElement("button");
          editBtn.className =
            "text-blue-600 hover:text-blue-900 transition-colors";
          editBtn.innerHTML = '<i class="fas fa-edit"></i>';
          editBtn.title = "Editar";
          editBtn.onclick = () => editTeacher(index);

          const deleteBtn = document.createElement("button");
          deleteBtn.className =
            "text-red-600 hover:text-red-900 transition-colors";
          deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
          deleteBtn.title = "Eliminar";
          deleteBtn.onclick = () => deleteTeacher(index);

          const subjectsBtn = document.createElement("button");
          subjectsBtn.className = "text-indigo-600 hover:text-indigo-900 transition-colors";
          subjectsBtn.innerHTML = '<i class="fas fa-book"></i>';
          subjectsBtn.title = "Materias";
          subjectsBtn.onclick = () => editSubjectsForTeacher(teacher.id);

          // Append actions and then hide for non-admins
          actionsCell.appendChild(editBtn);
          actionsCell.appendChild(deleteBtn);
          actionsCell.appendChild(subjectsBtn);
          try { if (typeof window.isAdminUser === 'function' && !window.isAdminUser((firebase && firebase.auth && firebase.auth().currentUser)||null)) { editBtn.style.display='none'; deleteBtn.style.display='none'; subjectsBtn.style.display='none'; } } catch(_) {}
          row.appendChild(actionsCell);

          tableBody.appendChild(row);
        });
      }

      // Update statistics
      function updateStats() {
        const totalTeachersCount = teachers.length;
        let totalCompletedActivities = 0;
        let totalPossibleActivities = 0;

        teachers.forEach((teacher) => {
          activities.forEach((activity) => {
            if (getActivityState(teacher, activity)) {
              totalCompletedActivities++;
            }
            totalPossibleActivities++;
          });
        });

        const averageCompletion =
          totalPossibleActivities > 0
            ? (
                (totalCompletedActivities / totalPossibleActivities) *
                100
              ).toFixed(1)
            : 0;
        const pendingActivities =
          totalPossibleActivities - totalCompletedActivities;

        // Update main stats
        document.getElementById("totalTeachers").textContent =
          totalTeachersCount;
        document.getElementById("completedActivities").textContent =
          totalCompletedActivities;
        document.getElementById("averageCompletion").textContent =
          averageCompletion + "%";
        document.getElementById("pendingActivities").textContent =
          pendingActivities;

        // Update mobile stats
        document.getElementById("mobileStatsTeachers").textContent =
          totalTeachersCount;
        document.getElementById("mobileStatsCompleted").textContent =
          totalCompletedActivities;
      }

      let currentChartType = "individual";
      let individualCharts = [];
      let generalChart = null;

      // Update charts based on activity completion
      function updateCharts() {
        const noChartsMessage = document.getElementById("noChartsMessage");

        if (teachers.length === 0 || activities.length === 0) {
          // Build admin hint if there are no activities
          let isAdmin = false;
          try {
            isAdmin = (typeof window.isAdminUser === 'function') && window.isAdminUser((firebase && firebase.auth && firebase.auth().currentUser) || null);
          } catch (e) { isAdmin = false; }
          if (activities.length === 0) {
            if (isAdmin) {
              noChartsMessage.innerHTML = `
                <div class="text-sm text-gray-700">
                  <p class="mb-2">No hay actividades configuradas.</p>
                  <div class="flex items-center gap-2 justify-center">
                    <button id="openAdminFromHint" class="px-3 py-1 bg-primary-600 text-white rounded text-xs hover:bg-primary-700">Abrir panel admin</button>
                    <button id="seedDemoFromHint" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-xs border hover:bg-gray-200">Cargar datos de prueba</button>
                  </div>
                </div>`;
            } else {
              noChartsMessage.innerHTML = `<div class="text-sm text-gray-500">Sin datos para mostrar.</div>`;
            }
          } else {
            noChartsMessage.innerHTML = `<div class="text-sm text-gray-500">Sin datos para mostrar.</div>`;
          }
          noChartsMessage.classList.remove("hidden");
          document
            .getElementById("individualChartsContainer")
            .classList.add("hidden");
          document
            .getElementById("generalChartContainer")
            .classList.add("hidden");
          // Bind hint buttons if present
          try {
            const openBtn = document.getElementById('openAdminFromHint');
            if (openBtn) openBtn.addEventListener('click', function(){
              const panel = document.getElementById('adminPanel');
              if (panel) { panel.classList.remove('hidden'); panel.classList.add('flex'); }
            });
            const seedBtn = document.getElementById('seedDemoFromHint');
            if (seedBtn) seedBtn.addEventListener('click', async function(){
              try {
                if (!window.api || typeof api.seedDemoData !== 'function') return;
                if (typeof showLoading === 'function') showLoading('Cargando datos de prueba...');
                await api.seedDemoData();
                await initializeApp();
                if (typeof showNotification === 'function') showNotification('Datos de prueba cargados', 'success');
              } catch (e) {
                console.warn(e);
              } finally { if (typeof hideLoading === 'function') hideLoading(); }
            });
          } catch (e) {}
          return;
        }

        noChartsMessage.classList.add("hidden");

        if (currentChartType === "individual") {
          updateIndividualCharts();
        } else {
          updateGeneralChart();
        }
      }

      // Show chart type (individual or general)
      function showChartType(type) {
        currentChartType = type;

        // Update button states
        document.querySelectorAll(".chart-type-btn").forEach((btn) => {
          btn.classList.remove("active", "bg-primary-500", "text-white");
          btn.classList.add("bg-gray-200", "text-gray-700");
        });

        const activeBtn = document.getElementById(type + "Btn");
        activeBtn.classList.add("active", "bg-primary-500", "text-white");
        activeBtn.classList.remove("bg-gray-200", "text-gray-700");

        // Show/hide containers
        if (type === "individual") {
          document
            .getElementById("individualChartsContainer")
            .classList.remove("hidden");
          document
            .getElementById("generalChartContainer")
            .classList.add("hidden");
          updateIndividualCharts();
        } else {
          document
            .getElementById("individualChartsContainer")
            .classList.add("hidden");
          document
            .getElementById("generalChartContainer")
            .classList.remove("hidden");
          updateGeneralChart();
        }
      }

      // Update individual teacher charts
      function updateIndividualCharts() {
        const container = document.getElementById("individualChartsContainer");
        container.innerHTML = "";

        // Destroy existing charts
        individualCharts.forEach((chart) => {
          if (chart) chart.destroy();
        });
        individualCharts = [];

        teachers.forEach((teacher, index) => {
          const hasAnyKey = activities.some(a => {
            try { return (teacher && teacher.activities && (a in teacher.activities)) || (a in teacher); } catch (_) { return false; }
          });
          const completedCount = activities.filter(
            (activity) => getActivityState(teacher, activity)
          ).length;
          const pendingCount = activities.length - completedCount;
          const progressPercent =
            activities.length > 0
              ? ((completedCount / activities.length) * 100).toFixed(1)
              : 0;
          const isNA = (activities.length === 0 || !hasAnyKey);
          const progressLabel = isNA ? 'N/A' : `${progressPercent}%`;
          const countLabel = isNA ? 'N/A' : `${completedCount}/${activities.length}`;
          const naHint = 'Sin actividades configuradas o no asignadas a este docente';

          const chartDiv = document.createElement("div");
          chartDiv.className = "bg-gray-50 rounded-lg p-4 border";
          chartDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-800">${teacher.name} ${teacher.lastName}</h4>
                            <p class="text-xs text-gray-600">${teacher.id}</p>
                        </div>
                        <div class="text-right">
                      <div class="text-lg font-bold text-primary-600" ${isNA ? 'title="'+naHint+'"' : ''}>${progressLabel}</div>
                      <div class="text-xs text-gray-500" ${isNA ? 'title="'+naHint+'"' : ''}>${countLabel}</div>
                        </div>
                    </div>
                    <div class="w-full"><canvas id="individualChart_${index}" class="w-full" style="height: 120px;"></canvas></div>
                `;
          container.appendChild(chartDiv);

          // Create individual chart
          const ctx = document
            .getElementById(`individualChart_${index}`)
            .getContext("2d");
          const chart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Completadas", "Pendientes"],
              datasets: [
                {
                  data: [completedCount, pendingCount],
                  backgroundColor: ["#2E7D32", "#E5E7EB"],
                  borderWidth: 2,
                  borderColor: "#ffffff",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "60%",
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || "";
                      const value = context.parsed;
                      const total = context.dataset.data.reduce(
                        (a, b) => a + b,
                        0
                      );
                      const percentage =
                        total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return `${label}: ${value} (${percentage}%)`;
                    },
                  },
                },
              },
            },
          });

          individualCharts.push(chart);
        });
      }

      // Update general progress chart
      function updateGeneralChart() {
        const container = document.getElementById("generalChartContainer");
        const statsContainer = document.getElementById("generalStats");

        // Destroy existing chart
        if (generalChart) {
          generalChart.destroy();
        }

        // Calculate general statistics
        let totalActivities = 0;
        let completedActivities = 0;
        let teachersWithFullCompletion = 0;
        let teachersWithPartialCompletion = 0;
        let teachersWithNoCompletion = 0;

        teachers.forEach((teacher) => {
          const completed = activities.filter(
            (activity) => teacher.activities[activity]
          ).length;
          totalActivities += activities.length;
          completedActivities += completed;

          if (completed === activities.length) {
            teachersWithFullCompletion++;
          } else if (completed > 0) {
            teachersWithPartialCompletion++;
          } else {
            teachersWithNoCompletion++;
          }
        });

        const overallProgress =
          totalActivities > 0
            ? ((completedActivities / totalActivities) * 100).toFixed(1)
            : 0;

        // Update statistics display
        statsContainer.innerHTML = `
                <div class="bg-green-50 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">${teachersWithFullCompletion}</div>
                    <div class="text-xs text-green-700">Completitud Total</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-600">${teachersWithPartialCompletion}</div>
                    <div class="text-xs text-yellow-700">Completitud Parcial</div>
                </div>
                <div class="bg-red-50 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-red-600">${teachersWithNoCompletion}</div>
                    <div class="text-xs text-red-700">Sin Completar</div>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">${overallProgress}%</div>
                    <div class="text-xs text-blue-700">Progreso General</div>
                </div>
            `;

        // Create general chart
        const ctx = document
          .getElementById("generalProgressChart")
          .getContext("2d");
        generalChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [
              "Completitud Total",
              "Completitud Parcial",
              "Sin Completar",
            ],
            datasets: [
              {
                data: [
                  teachersWithFullCompletion,
                  teachersWithPartialCompletion,
                  teachersWithNoCompletion,
                ],
                backgroundColor: ["#2E7D32", "#F59E0B", "#EF4444"],
                borderWidth: 3,
                borderColor: "#ffffff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "50%",
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  font: {
                    size: 12,
                  },
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.parsed;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0
                    );
                    const percentage =
                      total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value} docentes (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      // Filter table
      function filterTable() {
        const term = (document.getElementById('searchInput')?.value || '').toLowerCase();
        const bySubject = applySubjectFilterToList(teachers);
        filteredTeachers = bySubject.filter(t =>
          (String(t.id||'').toLowerCase().includes(term)) ||
          (String(t.name||'').toLowerCase().includes(term)) ||
          (String(t.lastName||'').toLowerCase().includes(term))
        );
        buildTable(); updateStats(); updateCharts();
      }

      // Modal functions
      function openAddModal() {
        document.getElementById("newTeacherId").value = "";
        document.getElementById("newTeacherName").value = "";
        document.getElementById("newTeacherLastName").value = "";
        clearErrors();
        document.getElementById("addModal").classList.remove("hidden");
        document.getElementById("addModal").classList.add("flex");
      }

      function closeAddModal() {
        document.getElementById("addModal").classList.add("hidden");
        document.getElementById("addModal").classList.remove("flex");
      }

      function openActivitiesModal() {
        renderActivitiesList();
        document.getElementById("activitiesModal").classList.remove("hidden");
        document.getElementById("activitiesModal").classList.add("flex");
      }

      function closeActivitiesModal() {
        document.getElementById("activitiesModal").classList.add("hidden");
        document.getElementById("activitiesModal").classList.remove("flex");
      }

      function clearErrors() {
        document.getElementById("idError").classList.add("hidden");
        document.getElementById("nameError").classList.add("hidden");
        document.getElementById("lastNameError").classList.add("hidden");
        document.getElementById("activityError").classList.add("hidden");
      }

      // Add new teacher
      async function addNewTeacher() {
        const id = document.getElementById("newTeacherId").value.trim();
        const name = document.getElementById("newTeacherName").value.trim();
        const lastName = document
          .getElementById("newTeacherLastName")
          .value.trim();

        clearErrors();

        let hasErrors = false;

        if (!id) {
          document.getElementById("idError").textContent = "El ID es requerido";
          document.getElementById("idError").classList.remove("hidden");
          hasErrors = true;
        } else if (teachers.some((t) => t.id === id)) {
          document.getElementById("idError").textContent = "Este ID ya existe";
          document.getElementById("idError").classList.remove("hidden");
          hasErrors = true;
        }

        if (!name) {
          document.getElementById("nameError").textContent =
            "El nombre es requerido";
          document.getElementById("nameError").classList.remove("hidden");
          hasErrors = true;
        }

        if (!lastName) {
          document.getElementById("lastNameError").textContent =
            "Los apellidos son requeridos";
          document.getElementById("lastNameError").classList.remove("hidden");
          hasErrors = true;
        }

        if (hasErrors) return;

        try {
          showLoading("Agregando docente...");
          const r = await api.addOrUpdateTeacher(id, name, lastName);
          if (!r || r.success === false)
            throw new Error(r && r.message ? r.message : "Error");
          closeAddModal();
          await initializeApp();
          showNotification("Docente agregado exitosamente", "success");
        } catch (e) {
          console.error(e);
          showNotification("No se pudo agregar el docente", "error");
        } finally { hideLoading(); }
      }

      // Edit teacher
      function editTeacher(index) {
        currentEditIndex = index;
        const teacher = filteredTeachers[index];

        document.getElementById("newTeacherId").value = teacher.id;
        document.getElementById("newTeacherName").value = teacher.name;
        document.getElementById("newTeacherLastName").value = teacher.lastName;

        // Change modal title and button
        document.querySelector("#addModal h3").textContent = "Editar Docente";
        document.querySelector(
          '#addModal button[onclick="addNewTeacher()"]'
        ).textContent = "Actualizar";
        document
          .querySelector('#addModal button[onclick="addNewTeacher()"]')
          .setAttribute("onclick", "updateTeacher()");

        openAddModal();
      }

      // Update teacher
      async function updateTeacher() {
        const id = document.getElementById("newTeacherId").value.trim();
        const name = document.getElementById("newTeacherName").value.trim();
        const lastName = document
          .getElementById("newTeacherLastName")
          .value.trim();

        clearErrors();

        let hasErrors = false;

        if (!id) {
          document.getElementById("idError").textContent = "El ID es requerido";
          document.getElementById("idError").classList.remove("hidden");
          hasErrors = true;
        } else if (
          teachers.some(
            (t, i) =>
              t.id === id &&
              i !== teachers.indexOf(filteredTeachers[currentEditIndex])
          )
        ) {
          document.getElementById("idError").textContent = "Este ID ya existe";
          document.getElementById("idError").classList.remove("hidden");
          hasErrors = true;
        }

        if (!name) {
          document.getElementById("nameError").textContent =
            "El nombre es requerido";
          document.getElementById("nameError").classList.remove("hidden");
          hasErrors = true;
        }

        if (!lastName) {
          document.getElementById("lastNameError").textContent =
            "Los apellidos son requeridos";
          document.getElementById("lastNameError").classList.remove("hidden");
          hasErrors = true;
        }

        if (hasErrors) return;

        try {
          showLoading("Actualizando docente...");
          const teacher = filteredTeachers[currentEditIndex];
          const originalIndex = teacher && teacher.originalIndex;
          const r = await api.updateTeacherData(
            originalIndex,
            id,
            name,
            lastName
          );
          if (!r || r.success === false)
            throw new Error(r && r.message ? r.message : "Error");
          closeAddModal();
          resetAddModal();
          await initializeApp();
          showNotification("Docente actualizado exitosamente", "success");
        } catch (e) {
          console.error(e);
          showNotification("No se pudo actualizar", "error");
        } finally { hideLoading(); }
      }

      // Reset add modal
      function resetAddModal() {
        document.querySelector("#addModal h3").textContent = "Nuevo Docente";
        document.querySelector(
          '#addModal button[onclick="updateTeacher()"]'
        ).textContent = "Guardar";
        document
          .querySelector('#addModal button[onclick="updateTeacher()"]')
          .setAttribute("onclick", "addNewTeacher()");
        currentEditIndex = -1;
      }

      // Delete teacher
      async function deleteTeacher(index) {
        if (confirm("¿Estás seguro de que deseas eliminar este docente?")) {
          const teacherIndex = teachers.indexOf(filteredTeachers[index]);
          teachers.splice(teacherIndex, 1);
          filteredTeachers = [...teachers];

          if (teachers.length === 0) {
            document.getElementById("tableContainer").classList.add("hidden");
            document.getElementById("emptyState").classList.remove("hidden");
          } else {
            buildTable();
          }

          updateStats();
          updateCharts();
          showNotification("Docente eliminado exitosamente", "success");
        }
      }

      // Delete selected teachers
      function deleteSelected() {
        const selectedCheckboxes = document.querySelectorAll(
          ".select-row:checked"
        );
        if (selectedCheckboxes.length === 0) {
          showNotification(
            "Por favor, selecciona al menos un docente",
            "error"
          );
          return;
        }

        if (
          confirm(
            `¿Estás seguro de que deseas eliminar ${selectedCheckboxes.length} docente(s)?`
          )
        ) {
          const indicesToDelete = Array.from(selectedCheckboxes).map((cb) =>
            parseInt(cb.dataset.index)
          );

          // Sort indices in descending order to avoid index shifting issues
          indicesToDelete.sort((a, b) => b - a);

          indicesToDelete.forEach((index) => {
            const teacherIndex = teachers.indexOf(filteredTeachers[index]);
            teachers.splice(teacherIndex, 1);
          });

          filteredTeachers = [...teachers];

          if (teachers.length === 0) {
            document.getElementById("tableContainer").classList.add("hidden");
            document.getElementById("emptyState").classList.remove("hidden");
          } else {
            buildTable();
          }

          updateStats();
          updateCharts();
          showNotification(
            `${indicesToDelete.length} docente(s) eliminado(s) exitosamente`,
            "success"
          );
        }
      }

      // Activities management
      function renderActivitiesList() {
        const activitiesList = document.getElementById("activitiesList");
        activitiesList.innerHTML = activities
          .map(
            (activity, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-900">${activity}</span>
                    <button onclick="removeActivity(${index})" class="text-red-600 hover:text-red-800 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `
          )
          .join("");
      }

      function addActivity() {
        const activityName = document
          .getElementById("newActivityName")
          .value.trim();
        document.getElementById("activityError").classList.add("hidden");

        if (!activityName) {
          document.getElementById("activityError").textContent =
            "El nombre de la actividad es requerido";
          document.getElementById("activityError").classList.remove("hidden");
          return;
        }

        if (activities.includes(activityName)) {
          document.getElementById("activityError").textContent =
            "Esta actividad ya existe";
          document.getElementById("activityError").classList.remove("hidden");
          return;
        }

        activities.push(activityName);
        document.getElementById("newActivityName").value = "";
        renderActivitiesList();
      }

      function removeActivity(index) {
        if (confirm("¿Estás seguro de que deseas eliminar esta actividad?")) {
          const activityName = activities[index];
          activities.splice(index, 1);

          // Remove activity from all teachers
          teachers.forEach((teacher) => {
            delete teacher.activities[activityName];
          });

          renderActivitiesList();
        }
      }

      async function saveActivities() {
        try {
          if (!window.api || typeof api.updateActivityHeaders !== 'function') throw new Error('API no disponible');
          showLoading('Guardando actividades...');
          await api.updateActivityHeaders(activities);
          await initializeApp();
          showNotification('Actividades actualizadas', 'success');
        } catch (e) {
          console.error(e);
          showNotification('No se pudieron guardar las actividades', 'error');
        } finally {
          hideLoading();
          closeActivitiesModal();
        }
      }

      async function renderRecentTeachersPreview() {
        try {
          const container = document.getElementById('recentTeachersPreview');
          if (!container) return;
          container.innerHTML = '<div class="text-sm text-gray-500">Cargando...</div>';
          if (!window.api || typeof api.getRecentTeachers !== 'function') {
            container.innerHTML = '<div class="text-sm text-gray-500">No disponible</div>';
            return;
          }
          const r = await api.getRecentTeachers(5);
          const items = (r && r.items) || [];
          if (items.length === 0) { container.innerHTML = '<div class="text-sm text-gray-500">Sin registros</div>'; return; }
          const total = Array.isArray(activities) ? activities.length : 0;
          container.innerHTML = items.map(t => {
            const completed = (activities||[]).filter(a => t.activities && t.activities[a]).length;
            const pct = total>0 ? Math.round((completed/total)*100) : 0;
            return `
              <div class="py-3 flex items-center justify-between">
                <div class="min-w-0">
                  <div class="font-medium text-gray-900 truncate">${t.lastName || ''}, ${t.name || ''} <span class="text-gray-400 text-xs ml-2">${t.id || ''}</span></div>
                  <div class="text-xs text-gray-500">${completed}/${total} actividades • ${pct}%</div>
                </div>
                <div class="w-32 bg-gray-100 rounded-full h-2 ml-4" aria-hidden="true">
                  <div class="bg-primary-500 h-2 rounded-full" style="width:${pct}%;"></div>
                </div>
              </div>
            `;
          }).join('');
        } catch (e) { console.warn('recent preview error', e); }
      }

      // Generate PDF report
      async function generateReport() {
        if (teachers.length === 0) {
          showNotification("No hay datos para generar el reporte", "error");
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape" });

        // Header
        doc.setFontSize(18);
        doc.setTextColor("#2E7D32");
        doc.text("Reporte de Control Académico", 14, 22);

        doc.setFontSize(12);
        doc.setTextColor("#000000");
        doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, 35);
        doc.text(`Total de Docentes: ${teachers.length}`, 14, 45);

        // (chart will be rendered below after computing stats)

        // General progress stats for chart
        let full = 0, partial = 0, none = 0;
        teachers.forEach((t) => {
          const completed = activities.filter((a) => t.activities[a]).length;
          if (completed === activities.length && activities.length > 0) full++;
          else if (completed > 0) partial++;
          else none++;
        });

        // Chart image
        const canvas = document.createElement("canvas");
        canvas.width = 500; canvas.height = 300;
        const ctx = canvas.getContext("2d");
        const chart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Completitud Total", "Completitud Parcial", "Sin Completar"],
            datasets: [{ data: [full, partial, none], backgroundColor: ["#2E7D32", "#F59E0B", "#EF4444"], borderColor: "#fff", borderWidth: 2 }],
          },
          options: { responsive: false, maintainAspectRatio: false, cutout: "55%", plugins: { legend: { display: false } } },
        });
        await new Promise((r) => setTimeout(r, 100));
        const chartImg = canvas.toDataURL("image/png");
        try { chart.destroy(); } catch(e) {}

        doc.setFontSize(14);
        doc.text("Progreso General", 14, 60);
        doc.addImage(chartImg, "PNG", 14, 65, 120, 80);
        doc.setFontSize(10);
        doc.text(`Completitud Total: ${full}`, 140, 80);
        doc.text(`Completitud Parcial: ${partial}`, 140, 90);
        doc.text(`Sin Completar: ${none}`, 140, 100);

        // Table data
        const tableData = teachers.map((teacher) => {
          const completedCount = activities.filter(
            (activity) => teacher.activities[activity]
          ).length;
          const progress =
            activities.length > 0
              ? ((completedCount / activities.length) * 100).toFixed(1) + "%"
              : "N/A";

          return [
            teacher.id,
            teacher.name,
            teacher.lastName,
            ...activities.map((activity) =>
              teacher.activities[activity] ? "Sí" : "No"
            ),
            progress,
          ];
        });

        doc.autoTable({
          startY: 155,
          head: [["ID", "Nombre", "Apellidos", ...activities, "Progreso"]],
          body: tableData,
          theme: "grid",
          headStyles: {
            fillColor: "#2E7D32",
            textColor: "#FFFFFF",
            fontStyle: "bold",
          },
          alternateRowStyles: {
            fillColor: "#f9f9f9",
          },
          styles: {
            fontSize: 8,
            cellPadding: 3,
          },
        });

        doc.save(
          `reporte-academico-${new Date().toISOString().slice(0, 10)}.pdf`
        );
        showNotification("Reporte PDF generado exitosamente", "success");
      }

      // Show notification
      function showNotification(message, type = "success") {
        const container = document.getElementById("notificationContainer");
        const notification = document.createElement("div");

        const bgColor = type === "success" ? "bg-green-500" : "bg-red-500";
        const icon =
          type === "success" ? "fa-check-circle" : "fa-exclamation-circle";

        notification.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 transform transition-all duration-300 translate-x-full`;
        notification.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            `;

        container.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.classList.remove("translate-x-full");
        }, 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            notification.classList.add("translate-x-full");
            setTimeout(() => {
              if (notification.parentElement) {
                notification.remove();
              }
            }, 300);
          }
        }, 5000);
      }

      // Initialize app when page loads
      window.addEventListener("load", function () {
        // Initialize Google Sign-In (removed)

        // Check existing session via Firebase Auth handled below

        // Bloque demo eliminado/no utilizado
      });

      // Close mobile menu when clicking outside
      document.addEventListener("click", function (event) {
        const mobileMenu = document.getElementById("mobileMenu");
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");

        if (
          !mobileMenu.contains(event.target) &&
          !mobileMenuBtn.contains(event.target)
        ) {
          if (mobileMenu.classList.contains("mobile-menu-open")) {
            closeMobileMenu();
          }
        }
      });

      // Close modals when clicking outside
      document.addEventListener("click", function (event) {
        const addModal = document.getElementById("addModal");
        const activitiesModal = document.getElementById("activitiesModal");
        const subjectsModal = document.getElementById("subjectsModal");

        if (event.target === addModal) {
          closeAddModal();
          resetAddModal();
        }

        if (event.target === activitiesModal) {
          closeActivitiesModal();
        }
        if (event.target === subjectsModal) {
          closeSubjectsModal();
        }
      });
    </script>
    <script>
      // Overrides to ensure backend operations hit Firestore
      function logout() {
        if (confirm("¿Está seguro de que desea cerrar sesión?")) {
          // Clear user data
          currentUser = null;
          // Reset Google Sign-In
          if (typeof google !== "undefined" && google.accounts) {
            google.accounts.id.disableAutoSelect();
          }
          // Clear backend auth token
          if (window.setAuthToken) {
            window.setAuthToken(null);
          } else if (window.api && window.api.setAuthToken) {
            window.api.setAuthToken(null);
          }
          // Stop auto refresh and remove indicator
          if (typeof stopAutoRefresh === "function") stopAutoRefresh();
          const _bar = document.getElementById("refreshIndicatorBar");
          if (_bar && _bar.parentElement) { try { _bar.parentElement.removeChild(_bar); } catch (e) {} }
          // Toggle views
          document.getElementById("mainDashboard").classList.add("hidden");
          document.getElementById("loginPage").classList.remove("hidden");
          // Reset states
          hideLoginError();
          showLoginLoading(false);
          showNotification("Sesión cerrada exitosamente", "success");
        }
      }

      async function deleteTeacher(index) {
        if (confirm("¿Estás seguro de que deseas eliminar este docente?")) {
          try {
            showLoading("Eliminando docente...");
            const t = filteredTeachers[index];
            const r = await api.deleteMultipleTeachers([t.originalIndex]);
            if (!r || r.success === false)
              throw new Error(r && r.message ? r.message : "Error");
            await initializeApp();
            showNotification("Docente eliminado exitosamente", "success");
          } catch (e) {
            console.error(e);
            showNotification("No se pudo eliminar", "error");
          } finally { hideLoading(); }
        }
      }

      async function deleteSelected() {
        const selectedCheckboxes = document.querySelectorAll(
          ".select-row:checked"
        );
        if (selectedCheckboxes.length === 0) {
          showNotification(
            "Por favor, selecciona al menos un docente",
            "error"
          );
          return;
        }
        if (
          confirm(
            `¿Estás seguro de que deseas eliminar ${selectedCheckboxes.length} docente(s)?`
          )
        ) {
          try {
            showLoading("Eliminando docentes...");
            const indicesToDelete = Array.from(selectedCheckboxes).map((cb) =>
              parseInt(cb.dataset.index)
            );
            const originalIndices = indicesToDelete.map(
              (i) => filteredTeachers[i].originalIndex
            );
            const r = await api.deleteMultipleTeachers(originalIndices);
            if (!r || r.success === false)
              throw new Error(r && r.message ? r.message : "Error");
            await initializeApp();
            showNotification(
              `${indicesToDelete.length} docente(s) eliminado(s) exitosamente`,
              "success"
            );
          } catch (e) {
            console.error(e);
            showNotification("No se pudieron eliminar", "error");
          } finally { hideLoading(); }
        }
      }
    </script>
    
  </body>
</html>



















